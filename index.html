<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive Bee-Bot Mat</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <!--
        FIREBASE SDKs and INITIALIZATION
        NOTE: The Firebase configuration, app_id, and initial_auth_token are provided
        by the environment as global variables: __app_id, __firebase_config, and __initial_auth_token.
    -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, addDoc, collection, query, getDocs, deleteDoc, onSnapshot, setLogLevel, getDoc, updateDoc, where } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // CRITICAL FIX: All DOM manipulation MUST be inside DOMContentLoaded
        document.addEventListener('DOMContentLoaded', () => {

            // --- NEW HELPER FUNCTION: Image Resizing ---
            /**
             * Resizes a base64 image to a max width/height to save storage space.
             * @param {string} dataUrl The base64 data URL of the image.
             * @param {number} maxWidth The maximum width for the new image (e.g., 256).
             * @param {number} maxHeight The maximum height for the new image (e.g., 256).
             * @param {number} quality The JPEG quality (0.0 to 1.0, e.g., 0.7).
             * @returns {Promise<string>} A promise that resolves with the new, smaller base64 data URL.
             */
            function resizeImage(dataUrl, maxWidth = 256, maxHeight = 256, quality = 0.7) {
                return new Promise((resolve, reject) => {
                    // Check if it's a base64 image
                    if (!dataUrl || !dataUrl.startsWith('data:image')) {
                        // It's not an image we can process (e.g., already a URL, empty, or invalid), so just return it.
                        resolve(dataUrl);
                        return;
                    }

                    const img = new Image();
                    img.src = dataUrl;

                    img.onload = () => {
                        let width = img.width;
                        let height = img.height;

                        // Don't resize if it's already small
                        if (width <= maxWidth && height <= maxHeight) {
                            resolve(dataUrl); // Return original if already small enough
                            return;
                        }

                        // Calculate new dimensions, maintaining aspect ratio
                        if (width > height) {
                            if (width > maxWidth) {
                                height = Math.round((height * maxWidth) / width);
                                width = maxWidth;
                            }
                        } else {
                            if (height > maxHeight) {
                                width = Math.round((width * maxHeight) / height);
                                height = maxHeight;
                            }
                        }

                        const canvas = document.createElement('canvas');
                        canvas.width = width;
                        canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        
                        // Draw the image onto the canvas
                        ctx.drawImage(img, 0, 0, width, height);
                        
                        // Get the new base64 string
                        // Using image/jpeg for significant size reduction, even for PNGs.
                        const newDataUrl = canvas.toDataURL('image/jpeg', quality);
                        resolve(newDataUrl);
                    };

                    img.onerror = (error) => {
                        console.error("Error loading image for resizing:", error);
                        // Return the original URL on error
                        resolve(dataUrl); 
                    };
                });
            }
            // --- END HELPER FUNCTION ---


            // --- ENVIRONMENT VARIABLES (MANDATORY USE) ---
            const firebaseConfig = {
  apiKey: "AIzaSyA4VjMrkHhZ-rHr32-iziPPiBoL4JGkjjw",
  authDomain: "unboxing-ct--mat-generator.firebaseapp.com",
  projectId: "unboxing-ct--mat-generator",
  storageBucket: "unboxing-ct--mat-generator.firebasestorage.app",
  messagingSenderId: "169453856176",
  appId: "1:169453856176:web:3fe35bf413fa89915ea275",
  measurementId: "G-3F5PGB128B"
};

// This line MUST come AFTER the config object
const appId = firebaseConfig.projectId;

// This is our app's code, it comes AFTER your config
let app, auth, db;
let currentUserId = null;
let lessonCache = [];

            // --- GET DOM REFERENCES HERE (AFTER DOMContentLoaded) ---
            const loginBtn = document.getElementById('login-btn');
            const logoutBtn = document.getElementById('logout-btn-home');
            const logoutBtnGame = document.getElementById('logout-btn-game');
            const myLessonsBtn = document.getElementById('my-lessons-btn');
            const myLessonsModal = document.getElementById('my-lessons-modal');
            const myLessonsList = document.getElementById('my-lessons-list');
            const closeLessonsModalBtn = document.getElementById('close-lessons-modal');
            const saveLessonBtn = document.getElementById('save-lesson-btn');
            const saveLessonModal = document.getElementById('save-lesson-modal');
            const saveLessonModalCancel = document.getElementById('save-lesson-modal-cancel');
            const saveLessonModalSave = document.getElementById('save-lesson-modal-save');
            const lessonNameInput = document.getElementById('lesson-name-input');

            const shareLinkModal = document.getElementById('share-link-modal');
            const shareLinkInput = document.getElementById('share-link-input');
            const copyLinkBtn = document.getElementById('copy-link-btn');
            const closeShareModalBtn = document.getElementById('close-share-modal');

            const submissionsModal = document.getElementById('submissions-modal');
            const closeSubmissionsModalBtn = document.getElementById('close-submissions-modal');
            const submissionsList = document.getElementById('submissions-list');
            const submissionsLessonName = document.getElementById('submissions-lesson-name');
            const viewWorkModal = document.getElementById('view-work-modal');
            const closeViewWorkModalBtn = document.getElementById('close-view-work-modal');
            const viewWorkStudentName = document.getElementById('view-work-student-name');
            const viewWorkGrid = document.getElementById('view-work-grid');
            const viewWorkCanvas = document.getElementById('view-work-canvas');
            const viewWorkLoader = document.getElementById('view-work-loader');
            const viewWorkContent = document.getElementById('view-work-content');
            
            // --- VIZ FIX: New elements for modal slide controls ---
            const viewWorkPrevSlide = document.getElementById('view-work-prev-slide');
            const viewWorkNextSlide = document.getElementById('view-work-next-slide');
            const viewWorkSlideCounter = document.getElementById('view-work-slide-counter');


            const galleryBtn = document.getElementById('gallery-btn');
            const galleryModal = document.getElementById('public-gallery-modal');
            const closeGalleryModalBtn = document.getElementById('close-gallery-modal');
            const galleryList = document.getElementById('public-gallery-list');

            const settingsBtn = document.getElementById('settings-btn');
            const settingsBtnGame = document.getElementById('settings-btn-game');
            const settingsModal = document.getElementById('settings-modal');
            const closeSettingsModalBtn = document.getElementById('close-settings-modal');
            const apiKeyInput = document.getElementById('api-key-input');
            const saveApiKeyBtn = document.getElementById('save-api-key-btn');
            
            // --- NEW: Text Edit Modal Elements ---
            const textEditModal = document.getElementById('text-edit-modal');
            const textModalInput = document.getElementById('text-modal-input');
            const textModalCancelBtn = document.getElementById('text-modal-cancel');
            const textModalSaveBtn = document.getElementById('text-modal-save');
            const textModalSizeDown = document.getElementById('text-modal-size-down');
            const textModalSizeUp = document.getElementById('text-modal-size-up');
            const textModalCurrentSize = document.getElementById('text-modal-current-size');
            
            // --- NEW: Position Modal Elements ---
            const setPosModal = document.getElementById('set-pos-modal');
            const setPosModalCancel = document.getElementById('set-pos-modal-cancel');
            const setPosModalSave = document.getElementById('set-pos-modal-save');
            
            // --- NEW: Tutorial Modal Elements ---
            const tutorialBtn = document.getElementById('tutorial-btn');
            const tutorialModal = document.getElementById('tutorial-modal');
            const closeTutorialModalBtn = document.getElementById('close-tutorial-modal');
            const closeTutorialModalFooterBtn = document.getElementById('close-tutorial-modal-footer');
            
            // --- GALLERY PROMPT ELEMENTS ---
            const galleryPrompt = document.getElementById('gallery-prompt');


            // --- UI Helper Functions (Defined inside DOMContentLoaded scope) ---

            function handleAuthError(error) {
                console.error("Auth Sign-In Error:", error);
            }

            function showLoggedInUI(user) {
                loginBtn.classList.add('hidden');
                logoutBtn.classList.remove('hidden');
                myLessonsBtn.classList.remove('hidden');
                logoutBtnGame.classList.remove('hidden');
                saveLessonBtn.classList.remove('hidden');
                settingsBtn.classList.remove('hidden');
                settingsBtnGame.classList.remove('hidden');
            }

            function showLoggedOutUI() {
                loginBtn.classList.remove('hidden');
                logoutBtn.classList.add('hidden');
                myLessonsBtn.classList.add('hidden');
                logoutBtnGame.classList.add('hidden');
                saveLessonBtn.classList.add('hidden');
                myLessonsList.innerHTML = '<p class="text-gray-500">Log in to see your saved lessons.</p>';
                settingsBtn.classList.add('hidden');
                settingsBtnGame.classList.add('hidden');
            }

            // Helper to load all slides for a given lesson
            async function loadLessonSlides(lessonDocRef) {
                const slidesCollectionPath = `${lessonDocRef.path}/slides`;
                const q = query(collection(db, slidesCollectionPath));
                const querySnapshot = await getDocs(q);

                const slidesArray = [];
                querySnapshot.forEach((slideDoc) => {
                    const slide = slideDoc.data();
                    slide.id = slideDoc.id;
                    // VITAL: Re-parse the nested JSON strings
                    if (typeof slide.gridData === 'string') {
                        slide.gridData = JSON.parse(slide.gridData);
                    }
                    if (typeof slide.initialBeebotState === 'string') {
                        slide.initialBeebotState = JSON.parse(slide.initialBeebotState);
                    }
                    
                    // Reconstruct the lesson object structure expected by the app
                    slidesArray.push({
                        id: slide.id, // e.g., 'slide-0'
                        instruction: slide.instruction,
                        initialBeebotState: slide.initialBeebotState,
                        gridRows: slide.gridRows,
                        gridCols: slide.gridCols,
                        gridData: slide.gridData
                    });
                });
                
                // Sort slides by ID (e.g., 'slide-0', 'slide-1') to maintain order
                slidesArray.sort((a, b) => {
                    const aIndex = parseInt(a.id.split('-')[1], 10);
                    const bIndex = parseInt(b.id.split('-')[1], 10);
                    return aIndex - bIndex;
                });

                return slidesArray;
            }

            // Helper to delete a subcollection
            async function deleteCollection(collectionRef) {
                const q = query(collectionRef);
                const snapshot = await getDocs(q);
                
                if (snapshot.size === 0) return;

                const deletePromises = [];
                snapshot.forEach(doc => {
                    deletePromises.push(deleteDoc(doc.ref));
                });
                await Promise.all(deletePromises);
            }


            // --- FIREBASE INITIALIZATION ---
            try {
                // Initialize app with config from the environment
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                setLogLevel('Debug');

                // Make services available to the main app script
                window.firebaseServices = { db, appId, getDoc, doc, addDoc, collection, getAuth: () => auth, getDB: () => db, getApiKey, loadLessonSlides };

                // --- FIREBASE AUTHENTICATION (The "Bouncer") ---
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        // User is logged in (Teacher or successfully signed-in Student)
                        console.log("User is logged in:", user.uid);
                        currentUserId = user.uid;
                        showLoggedInUI(user);
                        loadUserLessons(user.uid);
                    } else {
                        // User is logged out.
                        console.log("User is logged out.");
                        currentUserId = null;
                        showLoggedOutUI();

                        // FIX: Ensure Anonymous sign-in for students to read shared lessons
                        const initialToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                        
                        if (initialToken) {
                             signInWithCustomToken(auth, initialToken).catch((error) => {
                                 console.error("Custom Token Sign-In Failed, falling back to Anonymous:", error);
                                 // Fallback if custom token fails (rare)
                                 signInAnonymously(auth).catch(handleAuthError);
                             });
                        } else {
                             // Default to Anonymous Sign-In for all non-authenticated users (students)
                             signInAnonymously(auth).catch(handleAuthError);
                        }
                    }
                    updateGalleryButtonState();
                });


                // --- FIRESTORE DATABASE FUNCTIONS ---

                // 1. LOAD all lessons for the logged-in teacher (Real-Time)
                function loadUserLessons(userId) {
                    if (!userId) return;

                    myLessonsList.innerHTML = '<p class="text-gray-500">Loading lessons...</p>';

                    // Path to the teacher's private lesson collection
                    const lessonsCollectionPath = `artifacts/${appId}/users/${userId}/lessons`;
                    const q = query(collection(db, lessonsCollectionPath));

                    onSnapshot(q, (querySnapshot) => {
                        lessonCache = [];
                        if (querySnapshot.empty) {
                            myLessonsList.innerHTML = '<p class="text-gray-500">You have no saved lessons yet.</p>';
                            return;
                        }

                        myLessonsList.innerHTML = '';
                        querySnapshot.forEach((doc) => {
                            const lesson = doc.data();
                            lesson.id = doc.id;
                            // VITAL: Lesson now only contains metadata (no large config field)
                            lessonCache.push(lesson); 

                            const lessonEl = document.createElement('div');
                            lessonEl.className = "flex justify-between items-center p-3 bg-gray-100 rounded-lg";

                            const lessonName = document.createElement('span');
                            lessonName.textContent = lesson.name || 'Untitled Lesson';
                            lessonName.className = "font-semibold";
                            lessonEl.appendChild(lessonName);

                            const btnContainer = document.createElement('div');

                            const loadBtn = document.createElement('button');
                            loadBtn.textContent = 'Load';
                            loadBtn.className = "load-lesson-btn bg-blue-500 hover:bg-blue-600 text-white text-sm font-bold py-1 px-3 rounded-md shadow";
                            loadBtn.dataset.id = lesson.id;
                            btnContainer.appendChild(loadBtn);

                            const shareBtn = document.createElement('button');
                            shareBtn.textContent = 'Share';
                            shareBtn.className = "share-lesson-btn bg-purple-500 hover:bg-purple-600 text-white text-sm font-bold py-1 px-3 rounded-md shadow ml-2";
                            shareBtn.dataset.id = lesson.id;
                            btnContainer.appendChild(shareBtn);

                            const viewSubmissionsBtn = document.createElement('button');
                            viewSubmissionsBtn.textContent = 'Submissions';
                            viewSubmissionsBtn.className = "view-submissions-btn bg-cyan-500 hover:bg-cyan-600 text-white text-sm font-bold py-1 px-3 rounded-md shadow ml-2";
                            if (lesson.sharedLessonId) {
                                viewSubmissionsBtn.dataset.sharedId = lesson.sharedLessonId;
                                viewSubmissionsBtn.dataset.lessonName = lesson.name || 'Untitled Lesson';
                            } else {
                                viewSubmissionsBtn.disabled = true;
                                viewSubmissionsBtn.title = "Share this lesson first to enable submissions";
                                viewSubmissionsBtn.classList.add('opacity-50', 'cursor-not-allowed');
                            }
                            btnContainer.appendChild(viewSubmissionsBtn);

                            const publishBtn = document.createElement('button');
                            publishBtn.className = "publish-lesson-btn text-white text-sm font-bold py-1 px-3 rounded-md shadow ml-2";
                            publishBtn.dataset.privateId = lesson.id;

                            if (lesson.sharedLessonId) {
                                publishBtn.dataset.sharedId = lesson.sharedLessonId;
                                if (lesson.isPublic) {
                                    publishBtn.textContent = 'Unpublish';
                                    publishBtn.classList.add('bg-yellow-500', 'hover:bg-yellow-600');
                                    publishBtn.title = "Remove from public gallery";
                                } else {
                                    publishBtn.textContent = 'Publish';
                                    publishBtn.classList.add('bg-orange-500', 'hover:bg-orange-600');
                                    publishBtn.title = "Publish to public gallery";
                                }
                            } else {
                                publishBtn.textContent = 'Publish';
                                publishBtn.disabled = true;
                                publishBtn.title = "Share this lesson first to enable publishing";
                                publishBtn.classList.add('opacity-50', 'cursor-not-allowed', 'bg-gray-400');
                            }
                            btnContainer.appendChild(publishBtn);

                            const deleteBtn = document.createElement('button');
                            deleteBtn.textContent = 'Delete';
                            deleteBtn.className = "delete-lesson-btn bg-red-500 hover:bg-red-600 text-white text-sm font-bold py-1 px-3 rounded-md shadow ml-2";
                            deleteBtn.dataset.id = lesson.id;
                            btnContainer.appendChild(deleteBtn);

                            lessonEl.appendChild(btnContainer);
                            myLessonsList.appendChild(lessonEl);
                        });
                    }, (error) => {
                        console.error("Error loading lessons: ", error);
                        myLessonsList.innerHTML = '<p class="text-red-500">Error loading lessons.</p>';
                    });
                }

                // 2. SAVE the current lesson (CRITICAL FIX: Uses subcollection)
                async function saveLessonToFirestore(lessonName) {
                    if (!currentUserId) {
                        window.beebotApp.showToast("You must be logged in to save a lesson.", 3000);
                        return;
                    }

                    const lessonData = window.beebotApp.getLessonData();
                    const lessonsCollectionPath = `artifacts/${appId}/users/${currentUserId}/lessons`;

                    // --- IMAGE COMPRESSION STEP ---
                    // Create a deep copy to avoid modifying the in-memory lesson
                    const lessonDataToSave = JSON.parse(JSON.stringify(lessonData));
                    
                    try {
                        console.log("Starting image compression before save...");
                        // Process all images in the copied data
                        for (const slide of lessonDataToSave) {
                            if (slide.gridData) { // Ensure gridData exists
                                for (let r = 0; r < slide.gridData.length; r++) {
                                    for (let c = 0; c < slide.gridData[r].length; c++) {
                                        const cellData = slide.gridData[r][c];
                                        // Check for image type and if value is a base64 string
                                        if (cellData.type === 'image' && cellData.value && cellData.value.startsWith('data:image')) {
                                            // Resize the image. Using 256x256 and 70% quality.
                                            cellData.value = await resizeImage(cellData.value, 256, 256, 0.7);
                                        }
                                    }
                                }
                            }
                        }
                        console.log("Image compression finished.");
                        // --- END IMAGE COMPRESSION STEP ---

                        // --- 1. Create the main lesson metadata document ---
                        const docRef = await addDoc(collection(db, lessonsCollectionPath), {
                            name: lessonName,
                            gameMode: window.beebotApp.getGameMode(),
                            customBeeImageUrl: window.beebotApp.getCustomBeeImage(),
                            slideCount: lessonDataToSave.length, // Use the processed data
                            createdAt: new Date().toISOString(),
                            isPublic: false,
                            sharedLessonId: null
                        });

                        // --- 2. Save each slide to the subcollection ---
                        // **MODIFIED**: Use the compressed 'lessonDataToSave'
                        const slidePromises = lessonDataToSave.map((slide, index) => {
                            // Use deterministic slide IDs for predictable loading
                            const slideDocRef = doc(db, `${lessonsCollectionPath}/${docRef.id}/slides`, `slide-${index}`);
                            
                            // Prepare slide data for saving (stringify complex objects to avoid firestore internal errors)
                            const slideDataToSave = {
                                instruction: slide.instruction,
                                gridRows: slide.gridRows,
                                gridCols: slide.gridCols,
                                gridData: JSON.stringify(slide.gridData), 
                                initialBeebotState: JSON.stringify(slide.initialBeebotState),
                                index: index
                            };

                            return setDoc(slideDocRef, slideDataToSave);
                        });

                        await Promise.all(slidePromises);

                        console.log("Lesson saved with ID: ", docRef.id);
                        window.beebotApp.showToast("Lesson saved online!");
                        saveLessonModal.classList.add('hidden');
                    } catch (e) {
                        console.error("Error adding document: ", e);
                        window.beebotApp.showToast(`Error saving lesson: ${e.message}`, 3000);
                    }
                }

                // 3. SHARE a lesson (CRITICAL FIX: Copies metadata and slides subcollection)
                async function shareLesson(lessonId) {
                    if (!currentUserId) {
                        window.beebotApp.showToast("You must be logged in to share a lesson.", 3000);
                        return;
                    }

                    const lesson = lessonCache.find(l => l.id === lessonId);
                    if (!lesson) {
                        window.beebotApp.showToast("Error: Could not find lesson to share.", 3000);
                        return;
                    }

                    // If already shared, just show the link
                    if (lesson.sharedLessonId) {
                        const shareUrl = `${window.location.origin}${window.location.pathname}?lesson=${lesson.sharedLessonId}`;
                        shareLinkInput.value = shareUrl;
                        shareLinkModal.classList.remove('hidden');
                        shareLinkInput.select();
                        window.beebotApp.showToast("This lesson is already shared!");
                        return;
                    }

                    const publicCollectionPath = `artifacts/${appId}/public/data/shared-lessons`;
                    const privateLessonRef = doc(db, `artifacts/${appId}/users/${currentUserId}/lessons/${lessonId}`);

                    try {
                        // --- 1. Create public lesson metadata ---
                        const docRef = await addDoc(collection(db, publicCollectionPath), {
                            gameMode: lesson.gameMode,
                            customBeeImageUrl: lesson.customBeeImageUrl || null,
                            slideCount: lesson.slideCount,
                            teacherId: currentUserId,
                            originalName: lesson.name,
                            sharedAt: new Date().toISOString(),
                            isPublic: false
                        });
                        
                        // --- 2. Copy all slides to the public subcollection ---
                        const privateSlidesRef = collection(db, `${privateLessonRef.path}/slides`);
                        const publicSlidesCollectionRef = collection(db, `${docRef.path}/slides`);
                        const privateSlides = await getDocs(privateSlidesRef);
                        
                        const copyPromises = [];
                        privateSlides.forEach(slideDoc => {
                            // Use the same slide ID in the public subcollection
                            const publicSlideRef = doc(publicSlidesCollectionRef, slideDoc.id);
                            copyPromises.push(setDoc(publicSlideRef, slideDoc.data()));
                        });
                        await Promise.all(copyPromises);

                        // --- 3. Link the new public/shared ID back to the teacher's private lesson ---
                        await updateDoc(privateLessonRef, {
                            sharedLessonId: docRef.id
                        });

                        // Generate the shareable link
                        const shareUrl = `${window.location.origin}${window.location.pathname}?lesson=${docRef.id}`;

                        // Show the modal with the link
                        shareLinkInput.value = shareUrl;
                        shareLinkModal.classList.remove('hidden');
                        shareLinkInput.select();

                    } catch (e) {
                        console.error("Error sharing lesson: ", e);
                        window.beebotApp.showToast(`Error sharing lesson: ${e.message}`, 3000);
                    }
                }

                // 4. VIEW SUBMISSIONS (Logic unchanged, but the rendering now expects the new structure)
                async function viewSubmissions(sharedLessonId, lessonName) {
                    submissionsLessonName.textContent = lessonName;
                    submissionsList.innerHTML = '<p class="text-gray-500">Loading submissions...</p>';
                    submissionsModal.classList.remove('hidden');

                    try {
                        const submissionsCollectionPath = `artifacts/${appId}/public/data/student-submissions`;
                        const q = query(
                            collection(db, submissionsCollectionPath),
                            where("lessonId", "==", sharedLessonId)
                        );

                        const querySnapshot = await getDocs(q);

                        if (querySnapshot.empty) {
                            submissionsList.innerHTML = '<p class="text-gray-500">No submissions found for this lesson yet.</p>';
                            return;
                        }

                        submissionsList.innerHTML = '';
                        querySnapshot.forEach((doc) => {
                            const submission = doc.data();

                            const el = document.createElement('div');
                            el.className = "flex justify-between items-center p-3 bg-gray-100 rounded-lg";

                            const info = document.createElement('span');
                            const submittedDate = new Date(submission.submittedAt).toLocaleDateString();
                            info.textContent = `${submission.studentName || 'Anonymous'} (${submittedDate})`;
                            info.className = "font-semibold";
                            el.appendChild(info);

                            const viewBtn = document.createElement('button');
                            viewBtn.textContent = 'View Work';
                            viewBtn.className = "view-work-btn bg-blue-500 hover:bg-blue-600 text-white text-sm font-bold py-1 px-3 rounded-md shadow";
                            viewBtn.dataset.work = submission.work; // JSON string
                            viewBtn.dataset.studentName = submission.studentName || 'Anonymous';
                            viewBtn.dataset.sharedLessonId = sharedLessonId;
                            el.appendChild(viewBtn);

                            submissionsList.appendChild(el);
                        });

                    } catch (e) {
                        console.error("Error fetching submissions: ", e);
                        submissionsList.innerHTML = `<p class="text-red-500">Error loading submissions: ${e.message}</p>`;
                    }
                }
                
                // --- VIZ FIX: New function to handle rendering a specific slide ---
                function renderSubmissionSlide(slideIndex, lessonConfig, workData) {
                    // 1. Get current slide data
                    const slide = lessonConfig.lessonData[slideIndex];
                    const { gridRows, gridCols, gridData, initialBeebotState: initialState } = slide;
                    const slideCommands = workData[slideIndex] || [];

                    // 2. Update modal slide counter and navigation state
                    const viewWorkSlideControls = document.getElementById('view-work-slide-controls');
                    const viewWorkPrevSlide = document.getElementById('view-work-prev-slide');
                    const viewWorkNextSlide = document.getElementById('view-work-next-slide');
                    const viewWorkSlideCounter = document.getElementById('view-work-slide-counter');

                    viewWorkSlideCounter.textContent = `Slide ${slideIndex + 1} / ${lessonConfig.lessonData.length}`;
                    viewWorkPrevSlide.disabled = (slideIndex === 0);
                    viewWorkNextSlide.disabled = (slideIndex === lessonConfig.lessonData.length - 1);
                    viewWorkModal.dataset.currentVizIndex = slideIndex; // Store current index on modal
                    
                    // 3. Build the mini-grid UI
                    viewWorkGrid.innerHTML = ''; 
                    // CRITICAL FIX: Re-add the canvas element inside the grid container
                    viewWorkGrid.appendChild(viewWorkCanvas);
                    viewWorkGrid.style.gridTemplateRows = `repeat(${gridRows}, 1fr)`;
                    viewWorkGrid.style.gridTemplateColumns = `repeat(${gridCols}, 1fr)`;

                    for (let r = 0; r < gridRows; r++) {
                        for (let c = 0; c < gridCols; c++) {
                            const cellData = gridData[r][c];
                            const cell = document.createElement('div');
                            cell.className = 'view-work-cell';

                            if (cellData.type === 'image') {
                                const img = document.createElement('img');
                                img.src = cellData.value;
                                cell.appendChild(img);
                            } else if (cellData.type === 'text') {
                                const textDiv = document.createElement('div');
                                textDiv.className = 'view-work-cell-text';
                                textDiv.textContent = cellData.value;
                                const fontSize = cellData.fontSize || 16;
                                textDiv.style.fontSize = `${Math.max(fontSize / 2, 8)}px`;
                                cell.appendChild(textDiv);
                            }
                            viewWorkGrid.appendChild(cell);
                        }
                    }
                    
                    // --- Get canvas context and resize ---
                    const rect = viewWorkGrid.getBoundingClientRect();
                    const canvas = viewWorkCanvas;
                    canvas.width = rect.width;
                    canvas.height = rect.height;
                    const ctx = canvas.getContext('2d');
                    
                    // 4. Draw the path on the canvas (Simulation)
                    requestAnimationFrame(() => {
                        const cellWidth = canvas.width / gridCols;
                        const cellHeight = canvas.height / gridRows;

                        ctx.clearRect(0, 0, canvas.width, canvas.height); // Clear previous path
                        ctx.strokeStyle = '#FF0000'; // Student path is always red
                        ctx.lineWidth = 3;
                        ctx.lineCap = 'round';
                        ctx.lineJoin = 'round';

                        let pathSimState = { ...initialState };

                        ctx.beginPath();
                        // Move to start point
                        ctx.moveTo(pathSimState.col * cellWidth + cellWidth / 2, pathSimState.row * cellHeight + cellHeight / 2);

                        // Simulate the student's commands
                        for (const cmd of slideCommands) {
                            let moved = false;
                            let newRow = pathSimState.row;
                            let newCol = pathSimState.col;

                            if (cmd === 'F') {
                                if (pathSimState.dir === 0) newRow--; // Up
                                if (pathSimState.dir === 1) newCol++; // Right
                                if (pathSimState.dir === 2) newRow++; // Down
                                if (pathSimState.dir === 3) newCol--; // Left
                                moved = true;
                            } else if (cmd === 'B') {
                                if (pathSimState.dir === 0) newRow++; // Down
                                if (pathSimState.dir === 1) newCol--; // Left
                                if (pathSimState.dir === 2) newRow--; // Up
                                if (pathSimState.dir === 3) newCol++; // Right
                                moved = true;
                            } else if (cmd === 'L') {
                                pathSimState.dir = (pathSimState.dir + 3) % 4;
                            } else if (cmd === 'R') {
                                pathSimState.dir = (pathSimState.dir + 1) % 4;
                            }

                            // Boundary Check and Path Drawing
                            if (moved && newRow >= 0 && newRow < gridRows && newCol >= 0 && newCol < gridCols) {
                                pathSimState.row = newRow;
                                pathSimState.col = newCol;
                                ctx.lineTo(pathSimState.col * cellWidth + cellWidth / 2, pathSimState.row * cellHeight + cellHeight / 2);
                            }
                        }
                        ctx.stroke();

                        // Draw start point
                        ctx.fillStyle = 'green';
                        ctx.beginPath();
                        ctx.arc(initialState.col * cellWidth + cellWidth / 2, initialState.row * cellHeight + cellHeight / 2, 5, 0, 2 * Math.PI);
                        ctx.fill();
                        
                        // Draw end point if there was movement
                        if (slideCommands.length > 0) {
                            ctx.fillStyle = '#FF0000';
                            ctx.beginPath();
                            ctx.arc(pathSimState.col * cellWidth + cellWidth / 2, pathSimState.row * cellHeight + cellHeight / 2, 5, 0, 2 * Math.PI);
                            ctx.fill();
                        }
                    });
                    
                    // 5. Hide loader, show grid and controls
                    viewWorkLoader.classList.add('hidden');
                    viewWorkGrid.classList.remove('hidden');
                    viewWorkSlideControls.classList.remove('hidden');
                }


                // 5. VISUALIZE STUDENT WORK (CRITICAL FIX: Loads slides from subcollection)
                async function visualizeStudentWork(sharedLessonId, workString) {
                    try {
                        // Clear previous state and show loader
                        viewWorkGrid.innerHTML = ''; 
                        viewWorkCanvas.getContext('2d').clearRect(0, 0, viewWorkCanvas.width, viewWorkCanvas.height);
                        viewWorkLoader.classList.remove('hidden');
                        viewWorkGrid.classList.add('hidden');
                        viewWorkSlideControls.classList.add('hidden'); // Hide controls until data is ready

                        // 1. Fetch Lesson Config Metadata
                        const lessonDocPath = `artifacts/${appId}/public/data/shared-lessons/${sharedLessonId}`;
                        const lessonDocRef = doc(db, lessonDocPath);
                        const lessonDoc = await getDoc(lessonDocRef);

                        if (!lessonDoc.exists()) {
                            throw new Error("Lesson not found. It may have been deleted or unpublished.");
                        }
                        
                        const lessonMetadata = lessonDoc.data();

                        // 2. Fetch all Slides (lessonData) from subcollection
                        const lessonData = await window.firebaseServices.loadLessonSlides(lessonDocRef);
                        
                        // 3. Reconstruct the full config object expected by the render function
                        const lessonConfig = {
                            gameMode: lessonMetadata.gameMode,
                            customBeeImageUrl: lessonMetadata.customBeeImageUrl,
                            lessonData: lessonData // The reconstructed array of slide objects
                        };
                        
                        const workData = JSON.parse(workString);
                        
                        // 4. Store ALL data on the modal for navigation
                        viewWorkModal.dataset.lessonConfig = JSON.stringify(lessonConfig);
                        viewWorkModal.dataset.workData = workString;
                        
                        // 5. Populate the raw commands list (already correct)
                        let formattedWork = '';
                        if (workData && workData.length > 0) {
                            workData.forEach((slideCommands, index) => {
                                formattedWork += `Slide ${index + 1}:\n[ ${slideCommands.join(', ')} ]\n\n`;
                            });
                        } else {
                            formattedWork = 'No commands were submitted.';
                        }
                        viewWorkContent.textContent = formattedWork;
                        
                        // 6. Render the first slide (index 0)
                        renderSubmissionSlide(0, lessonConfig, workData);


                    } catch (e) {
                        console.error("Error visualizing student work:", e);
                        viewWorkContent.textContent = `Error: ${e.message}`;
                        viewWorkLoader.classList.add('hidden');
                    }
                }

                // 6. TOGGLE PUBLIC STATUS (Updated to use metadata only)
                async function toggleLessonPublic(privateId, sharedId, currentStatus) {
                    if (!currentUserId) return;

                    const newStatus = !currentStatus;
                    const publicLessonRef = doc(db, `artifacts/${appId}/public/data/shared-lessons/${sharedId}`);
                    const privateLessonRef = doc(db, `artifacts/${appId}/users/${currentUserId}/lessons/${privateId}`);

                    try {
                        // Update both public and private docs
                        await updateDoc(publicLessonRef, { isPublic: newStatus });
                        await updateDoc(privateLessonRef, { isPublic: newStatus });

                        if (newStatus) {
                            window.beebotApp.showToast("Lesson published to gallery!");
                        } else {
                            window.beebotApp.showToast("Lesson removed from gallery.");
                        }
                    } catch (e) {
                        console.error("Error updating public status:", e);
                        window.beebotApp.showToast(`Error: ${e.message}`, 3000);
                    }
                }

                // 7. LOAD PUBLIC GALLERY (No change, uses metadata)
                async function loadPublicGallery() {
                    galleryList.innerHTML = '<p class="text-gray-500">Loading public lessons...</p>';

                    try {
                        const publicCollectionPath = `artifacts/${appId}/public/data/shared-lessons`;
                        const q = query(
                            collection(db, publicCollectionPath),
                            where("isPublic", "==", true)
                        );

                        const querySnapshot = await getDocs(q);

                        if (querySnapshot.empty) {
                            galleryList.innerHTML = '<p class="text-gray-500">No public lessons found yet. Check back soon!</p>';
                            galleryPrompt.classList.remove('hidden'); // Show prompt when gallery is empty
                            return;
                        }
                        
                        // If lessons are found, hide the gallery prompt entirely
                        galleryPrompt.classList.add('hidden');


                        galleryList.innerHTML = '';
                        querySnapshot.forEach((doc) => {
                            const lesson = doc.data();
                            lesson.id = doc.id;

                            const el = document.createElement('div');
                            el.className = "flex justify-between items-center p-3 bg-gray-100 rounded-lg";

                            const info = document.createElement('span');
                            info.textContent = lesson.originalName || 'Untitled Lesson';
                            info.className = "font-semibold";
                            el.appendChild(info);

                            const cloneBtn = document.createElement('button');
                            cloneBtn.textContent = 'Clone';
                            cloneBtn.className = "clone-lesson-btn bg-green-500 hover:bg-green-600 text-white text-sm font-bold py-1 px-3 rounded-md shadow";
                            cloneBtn.dataset.publicId = lesson.id;
                            if (!currentUserId) {
                                cloneBtn.disabled = true;
                                cloneBtn.title = "Log in to clone this lesson";
                                cloneBtn.classList.add('opacity-50', 'cursor-not-allowed');
                            }
                            el.appendChild(cloneBtn);

                            galleryList.appendChild(el);
                        });

                    } catch (e) {
                        console.error("Error fetching public gallery: ", e);
                        galleryList.innerHTML = `<p class="text-red-500">Error loading gallery: ${e.message}</p>`;
                    }
                }

                // 8. UPDATE GALLERY BUTTON STATE (No change)
                function updateGalleryButtonState() {
                    const allCloneButtons = galleryList.querySelectorAll('.clone-lesson-btn');
                    if (currentUserId) {
                        allCloneButtons.forEach(btn => {
                            btn.disabled = false;
                            btn.title = "Clone to 'My Lessons'";
                            btn.classList.remove('opacity-50', 'cursor-not-allowed');
                        });
                        galleryPrompt.classList.add('hidden');
                    } else {
                        allCloneButtons.forEach(btn => {
                            btn.disabled = true;
                            btn.title = "Log in to clone this lesson";
                            btn.classList.add('opacity-50', 'cursor-not-allowed');
                        });
                        // The gallery prompt remains visible by default in the HTML on large screens
                    }
                }

                // 9. CLONE A PUBLIC LESSON (CRITICAL FIX: Clones metadata and slides subcollection)
                async function cloneLesson(publicId) {
                    if (!currentUserId) {
                        window.beebotApp.showToast("Please log in to clone lessons.", 3000);
                        return;
                    }

                    try {
                        const publicLessonRef = doc(db, `artifacts/${appId}/public/data/shared-lessons/${publicId}`);
                        const publicDoc = await getDoc(publicLessonRef);

                        if (!publicDoc.exists()) {
                            throw new Error("Public lesson not found.");
                        }

                        const publicLesson = publicDoc.data();
                        const privateCollectionPath = `artifacts/${appId}/users/${currentUserId}/lessons`;

                        // --- 1. Create the new private lesson metadata ---
                        const docRef = await addDoc(collection(db, privateCollectionPath), {
                            name: `(Clone) ${publicLesson.originalName || 'Untitled Lesson'}`,
                            gameMode: publicLesson.gameMode,
                            customBeeImageUrl: publicLesson.customBeeImageUrl || null,
                            slideCount: publicLesson.slideCount,
                            createdAt: new Date().toISOString(),
                            clonedFrom: publicId,
                            isPublic: false,
                            sharedLessonId: null
                        });
                        
                        // --- 2. Copy all slides from public subcollection to new private subcollection ---
                        const publicSlidesRef = collection(db, `${publicLessonRef.path}/slides`);
                        const privateSlidesCollectionRef = collection(db, `${privateCollectionPath}/${docRef.id}/slides`);
                        const publicSlides = await getDocs(publicSlidesRef);
                        
                        const copyPromises = [];
                        publicSlides.forEach(slideDoc => {
                            // Use the same slide ID in the new private subcollection
                            const privateSlideRef = doc(privateSlidesCollectionRef, slideDoc.id);
                            copyPromises.push(setDoc(privateSlideRef, slideDoc.data()));
                        });
                        await Promise.all(copyPromises);


                        console.log("Lesson cloned with ID:", docRef.id);
                        window.beebotApp.showToast("Lesson cloned! It's now in 'My Lessons'.");
                        galleryModal.classList.add('hidden');

                    } catch (e) {
                        console.error("Error cloning lesson:", e);
                        window.beebotApp.showToast(`Error cloning lesson: ${e.message}`, 3000);
                    }
                }


                // 10. DELETE a specific lesson (CRITICAL FIX: Deletes the slides subcollection)
                async function deleteLesson(lessonId) {
                    if (!currentUserId) return;

                    const lesson = lessonCache.find(l => l.id === lessonId);
                    
                    if (lesson && lesson.sharedLessonId) {
                        const publicLessonRef = doc(db, `artifacts/${appId}/public/data/shared-lessons/${lesson.sharedLessonId}`);
                        const publicSlidesRef = collection(db, `${publicLessonRef.path}/slides`);
                        try {
                            // Delete public slides first
                            await deleteCollection(publicSlidesRef);
                            // Then delete the public metadata doc
                            await deleteDoc(publicLessonRef);
                            window.beebotApp.showToast("Public copy deleted.", 2000);
                        } catch (e) {
                            console.error("Error deleting public lesson/slides, proceeding with private delete:", e);
                        }
                    }

                    const privateLessonRef = doc(db, `artifacts/${appId}/users/${currentUserId}/lessons/${lessonId}`);
                    const privateSlidesRef = collection(db, `${privateLessonRef.path}/slides`);

                    try {
                        // Delete private slides first
                        await deleteCollection(privateSlidesRef);
                        // Then delete the private metadata doc
                        await deleteDoc(privateLessonRef);
                        window.beebotApp.showToast("Lesson deleted.");
                    } catch (e) {
                        console.error("Error deleting document: ", e);
                    }
                }

                // 11. LOAD a specific lesson to the editor (CRITICAL FIX: Loads slides from subcollection)
                async function loadSpecificLesson(lessonId) {
                    const lessonMetadata = lessonCache.find(l => l.id === lessonId);
                    if (!lessonMetadata) {
                        console.error("Could not find lesson in cache.");
                        return;
                    }

                    const lessonDocRef = doc(db, `artifacts/${appId}/users/${currentUserId}/lessons/${lessonId}`);
                    
                    try {
                        const lessonData = await window.firebaseServices.loadLessonSlides(lessonDocRef);

                        // Reconstruct the full config object expected by the app
                        const fullLessonConfig = {
                            gameMode: lessonMetadata.gameMode,
                            customBeeImageUrl: lessonMetadata.customBeeImageUrl,
                            lessonData: lessonData // The reconstructed array of slides
                        };
                        
                        // Pass the reconstructed config object to the app
                        window.beebotApp.loadSavedLesson(fullLessonConfig);
                        myLessonsModal.classList.add('hidden');

                    } catch(e) {
                        console.error("Error loading lesson slides:", e);
                        window.beebotApp.showToast("Error loading lesson details.", 3000);
                    }
                }

                // 12. SAVE API KEY (No change)
                async function saveApiKey() {
                    if (!currentUserId) return;

                    const key = apiKeyInput.value.trim();
                    if (!key) {
                        window.beebotApp.showToast("Please enter an API key.", 2000);
                        return;
                    }

                    const encodedKey = btoa(key);
                    const settingsDocPath = `artifacts/${appId}/users/${currentUserId}/settings/main`;

                    try {
                        await setDoc(doc(db, settingsDocPath), {
                            geminiApiKey: encodedKey
                        }, { merge: true });

                        window.beebotApp.showToast("API Key saved securely!");
                        settingsModal.classList.add('hidden');
                    } catch (e) {
                        console.error("Error saving API key:", e);
                        window.beebotApp.showToast("Error saving key.", 2000);
                    }
                }

                // 13. GET API KEY (No change)
                async function getApiKey() {
                    if (!currentUserId) return null;

                    const settingsDocPath = `artifacts/${appId}/users/${currentUserId}/settings/main`;

                    try {
                        const docSnap = await getDoc(doc(db, settingsDocPath));
                        if (docSnap.exists() && docSnap.data().geminiApiKey) {
                            return atob(docSnap.data().geminiApiKey);
                        }
                        return null;
                    } catch (e) {
                        console.error("Error fetching API key:", e);
                        return null;
                    }
                }


                // --- FIREBASE-RELATED EVENT LISTENERS ---

                // CRITICAL FIX: The event listeners must be placed here, after the DOM elements are retrieved.
                loginBtn.addEventListener('click', async () => {
                    const provider = new GoogleAuthProvider();
                    try {
                        await signInWithPopup(auth, provider);
                    } catch (error) {
                        console.error("Login Error:", error);
                        window.beebotApp.showToast(`Login failed: ${error.message}`, 3000);
                    }
                });

                const handleLogout = async () => {
                    try {
                        await signOut(auth);
                        window.location.reload();
                    } catch (error) {
                        console.error("Logout Error:", error);
                    }
                };
                logoutBtn.addEventListener('click', handleLogout);
                logoutBtnGame.addEventListener('click', handleLogout);
                
                // --- NEW: Tutorial Button Listeners ---
                tutorialBtn.addEventListener('click', () => {
                    tutorialModal.classList.remove('hidden');
                });
                closeTutorialModalBtn.addEventListener('click', () => {
                    tutorialModal.classList.add('hidden');
                });
                // Ensure the footer button also closes the modal
                closeTutorialModalFooterBtn.addEventListener('click', () => {
                    tutorialModal.classList.add('hidden');
                });


                myLessonsBtn.addEventListener('click', () => myLessonsModal.classList.remove('hidden'));
                closeLessonsModalBtn.addEventListener('click', () => myLessonsModal.classList.add('hidden'));

                saveLessonBtn.addEventListener('click', () => {
                    lessonNameInput.value = `My Lesson ${lessonCache.length + 1}`;
                    saveLessonModal.classList.remove('hidden');
                    lessonNameInput.focus();
                });
                saveLessonModalCancel.addEventListener('click', () => saveLessonModal.classList.add('hidden'));
                saveLessonModalSave.addEventListener('click', () => {
                    const lessonName = lessonNameInput.value.trim();
                    if (lessonName) {
                        saveLessonToFirestore(lessonName);
                    } else {
                        window.beebotApp.showToast("Please enter a name for your lesson.", 2000);
                    }
                });

                myLessonsList.addEventListener('click', (e) => {
                    const target = e.target;
                    if (target.classList.contains('load-lesson-btn')) {
                        loadSpecificLesson(target.dataset.id);
                    } else if (target.classList.contains('delete-lesson-btn')) {
                        deleteLesson(target.dataset.id);
                    } else if (target.classList.contains('share-lesson-btn')) {
                        shareLesson(target.dataset.id);
                    } else if (target.classList.contains('view-submissions-btn')) {
                        viewSubmissions(target.dataset.sharedId, target.dataset.lessonName);
                    } else if (target.classList.contains('publish-lesson-btn')) {
                        const currentStatus = target.textContent === 'Unpublish';
                        toggleLessonPublic(target.dataset.privateId, target.dataset.sharedId, currentStatus);
                    }
                });

                closeShareModalBtn.addEventListener('click', () => shareLinkModal.classList.add('hidden'));

                copyLinkBtn.addEventListener('click', () => {
                    shareLinkInput.select();
                    try {
                        document.execCommand('copy'); // For iFrame compatibility
                        window.beebotApp.showToast("Link copied to clipboard!", 2000);
                    } catch (err) {
                        console.error('Failed to copy: ', err);
                        window.beebotApp.showToast("Failed to copy link.", 2000);
                    }
                });

                closeSubmissionsModalBtn.addEventListener('click', () => submissionsModal.classList.add('hidden'));

                submissionsList.addEventListener('click', (e) => {
                    if (e.target.classList.contains('view-work-btn')) {
                        const { studentName, work, sharedLessonId } = e.target.dataset;

                        viewWorkStudentName.textContent = `${studentName}'s Submitted Work`;

                        viewWorkGrid.innerHTML = '';
                        viewWorkCanvas.getContext('2d').clearRect(0, 0, viewWorkCanvas.width, viewWorkCanvas.height);
                        viewWorkLoader.classList.remove('hidden');
                        viewWorkGrid.classList.add('hidden');

                        viewWorkModal.classList.remove('hidden');

                        visualizeStudentWork(sharedLessonId, work);
                    }
                });

                closeViewWorkModalBtn.addEventListener('click', () => viewWorkModal.classList.add('hidden'));
                
                // --- VIZ FIX: Navigation listeners for the submission modal ---
                const handleVizNavigation = (direction) => {
                    const currentIndex = parseInt(viewWorkModal.dataset.currentVizIndex, 10);
                    // The lessonConfig is stored as a JSON string in the modal dataset
                    const lessonConfig = JSON.parse(viewWorkModal.dataset.lessonConfig);
                    const workData = JSON.parse(viewWorkModal.dataset.workData);
                    
                    let newIndex = currentIndex + direction;
                    
                    if (newIndex >= 0 && newIndex < lessonConfig.lessonData.length) {
                        renderSubmissionSlide(newIndex, lessonConfig, workData);
                    }
                };

                const viewWorkSlideControls = document.getElementById('view-work-slide-controls');
                const viewWorkPrevSlide = document.getElementById('view-work-prev-slide');
                const viewWorkNextSlide = document.getElementById('view-work-next-slide');

                viewWorkPrevSlide.addEventListener('click', () => handleVizNavigation(-1));
                viewWorkNextSlide.addEventListener('click', () => handleVizNavigation(1));


                galleryBtn.addEventListener('click', () => {
                    galleryModal.classList.remove('hidden');
                    loadPublicGallery();
                });

                closeGalleryModalBtn.addEventListener('click', () => galleryModal.classList.add('hidden'));

                galleryList.addEventListener('click', (e) => {
                    if (e.target.classList.contains('clone-lesson-btn')) {
                        cloneLesson(e.target.dataset.publicId);
                    }
                });

                const openSettings = async () => {
                    apiKeyInput.value = '';
                    const key = await getApiKey();
                    if (key) {
                        apiKeyInput.value = key;
                    }
                    settingsModal.classList.remove('hidden');
                    apiKeyInput.focus();
                };
                settingsBtn.addEventListener('click', openSettings);
                settingsBtnGame.addEventListener('click', openSettings);

                closeSettingsModalBtn.addEventListener('click', () => settingsModal.classList.add('hidden'));

                saveApiKeyBtn.addEventListener('click', saveApiKey);


            } catch (e) {
                console.error("Firebase initialization failed:", e);
                document.querySelectorAll('.auth-required').forEach(el => el.classList.add('hidden'));
            }

        });
    </script>
    <style>
        /* --- GLOBAL SCROLL FIX --- */
        body, html {
            height: 100%;
            overflow-y: auto; /* Allow vertical scrolling */
            overflow-x: hidden; /* Prevent horizontal scrolling */
            font-family: 'Inter', sans-serif;
        }
        /* --- END GLOBAL SCROLL FIX --- */
        
        #grid-container {
            display: grid;
            position: relative;
            border: 2px solid #333;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            aspect-ratio: 1 / 1;
            max-width: 100%;
            max-height: 100%;
        }
        .grid-cell {
            width: 100%;
            height: 100%;
            border: 1px solid #ccc;
            box-sizing: border-box;
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: #333;
            overflow: hidden;
            position: relative;
            transition: transform 0.2s ease-in-out, opacity 0.2s ease-in-out, background-color 0.2s;
        }
        .grid-cell.dragging {
            opacity: 0.4;
            transform: scale(0.9);
        }

        .grid-cell.text-mode { cursor: pointer; }
        .grid-cell.text-mode:not(.student-mode):hover { background-color: #e0f7fa; }
        .grid-cell.image-mode { cursor: pointer; }
        .grid-cell.image-mode:not(.student-mode):hover { background-color: #e8f5e9; }
        .grid-cell.ai-mode { cursor: pointer; }
        .grid-cell.ai-mode:not(.student-mode):hover { background-color: #ede7f6; }
        .grid-cell.unbox-mode { cursor: pointer; }
        .grid-cell.unbox-mode:not(.student-mode):hover { background-color: #ecfeff; }
        .grid-cell.image-mode.has-image:not(.student-mode),
        .grid-cell.ai-mode.has-image:not(.student-mode),
        .grid-cell.unbox-mode.has-image:not(.student-mode) { cursor: grab; }
        .grid-cell.image-mode.has-image:not(.student-mode):active,
        .grid-cell.ai-mode.has-image:not(.student-mode):active,
        .grid-cell.unbox-mode.has-image:not(.student-mode):active { cursor: grabbing; }

        .grid-cell.selected {
            border: 3px solid #0288d1;
            box-shadow: 0 0 10px #0288d1;
        }
        .grid-cell img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            pointer-events: none;
        }
        .grid-cell .cell-text {
            padding: 5%;
            text-align: center;
            word-break: break-word;
            transition: font-size 0.2s ease-in-out;
            user-select: none;
            pointer-events: none;
        }

        #beebot {
            position: absolute;
            background-image: url('https://img.icons8.com/plasticine/100/000000/bee.png');
            background-size: 80%;
            background-repeat: no-repeat;
            background-position: center;
            transition: top 0.5s ease-in-out, left 0.5s ease-in-out, transform 0.5s ease-in-out;
            z-index: 10;
        }
        .command-btn, .slide-btn {
            transition: all 0.15s ease-out;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .command-btn:active, .slide-btn:active {
            transform: translateY(2px);
            box-shadow: 0 2px 3px rgba(0,0,0,0.1);
        }
        #path-canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 5;
        }

        /* --- VIZ: Added styles for the new visualizer modal --- */
        #view-work-grid {
            display: grid;
            position: relative;
            border: 2px solid #666;
            background-color: #f9f9f9;
            width: 100%;
            aspect-ratio: 1 / 1;
        }
        /* CRITICAL FIX: The canvas inside the view grid must be positioned absolutely over the grid cells */
        #view-work-grid > canvas { 
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 5;
        }
        .view-work-cell {
            width: 100%;
            height: 100%;
            border: 1px solid #ccc;
            box-sizing: border-box;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            position: relative;
        }
        .view-work-cell img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .view-work-cell-text {
            padding: 2%;
            text-align: center;
            word-break: break-word;
            font-weight: bold;
            color: #333;
        }
        /* Ensure 3-column layout has correct height on lg screens */
        @media (min-width: 1024px) {
            #game-page > .flex-col {
                height: calc(100vh - 2rem);
            }
        }
        
        /* --- NEW LANDSCAPE OPTIMIZATION --- */
        /* Forces the central grid area to use full available screen height in landscape view */
        @media (max-width: 1023px) and (orientation: landscape) {
            #game-page {
                padding: 0.5rem; /* Reduce padding to maximize space */
            }
            #game-page > .flex-col {
                height: calc(100vh - 1rem); /* Use full viewport height minus minimal padding */
                min-height: 0; /* Allow Flexbox item to shrink correctly */
            }
            /* Adjust the grid container section to take up available height */
            #game-page .lg\:w-1\/2 {
                height: 65vh; /* Keep some space for controls below */
                min-height: 0;
            }
             /* Adjust controls and sequence sections to fit below the grid */
            #game-page .lg\:w-1\/4 {
                height: 35vh; /* Allocate remaining space for controls and sequence */
                overflow-y: auto; /* Enable scrolling for controls if needed */
            }
            
            /* On small landscape screens, we need to ensure the grid is vertically centered */
            #game-page .flex-grow.flex.items-center.justify-center {
                height: 100%;
            }
        }
        /* Style for the collapsible tutorial sections */
        .tutorial-details summary {
            cursor: pointer;
            list-style: none; /* Hide default marker */
            padding: 1rem 0;
            border-bottom: 1px solid #ddd;
            font-weight: 600;
            color: #1f2937;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .tutorial-details summary::-webkit-details-marker {
            display: none;
        }
        .tutorial-details summary::after {
            content: '';
            margin-left: 0.5rem;
            transition: transform 0.2s;
        }
        .tutorial-details[open] summary::after {
            content: '';
        }
        .tutorial-content {
            padding: 0.5rem 0 1rem 1rem;
            border-bottom: 1px solid #ddd;
        }
        .tutorial-content ul {
            padding-left: 1rem;
            margin-top: 0.5rem;
        }
        
        /* --- GALLERY PROMPT STYLES --- */
        @keyframes bounce-right {
            0%, 100% { transform: translateX(0); }
            50% { transform: translateX(5px); }
        }
        /* Container for the button and the prompt bubble */
        #gallery-cta-container {
            position: absolute;
            top: 1rem;
            left: 1rem; /* Anchor to top left */
            z-index: 20;
            /* Flex properties are now on the wrapper div in HTML */
        }
        #gallery-prompt {
            background-color: #fef3c7; /* Light yellow */
            color: #b45309; /* Dark orange text */
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-size: 0.875rem;
            font-weight: 600;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            position: relative;
        }
        #gallery-prompt::before {
            content: '';
            position: absolute;
            right: 100%;
            top: 50%;
            width: 0;
            height: 0;
            border-top: 8px solid transparent;
            border-bottom: 8px solid transparent;
            border-right: 8px solid #fef3c7;
            transform: translateY(-50%);
        }
        .bounce-arrow {
            color: #ef4444; /* Red arrow */
            font-size: 1.5rem;
            animation: bounce-right 1s infinite;
        }
    </style>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body class="bg-gray-100 flex flex-col items-center justify-center h-screen overflow-hidden">

    <!-- Homepage View -->
    <div id="home-page" class="w-full max-w-lg mx-auto text-center p-4">
        
        <!-- NEW LEFT-SIDE CALL TO ACTION (Gallery + Prompt) -->
        <div id="gallery-cta-container" class="flex items-center space-x-2">
            
            <button id="gallery-btn" class="bg-teal-600 hover:bg-teal-500 text-white font-extrabold py-3 px-5 rounded-lg shadow-xl transition duration-200 transform hover:scale-105">
                Browse Gallery
            </button>
            
            <!-- This wraps the arrow and the bubble text -->
            <!-- It remains visible by default on large screens -->
            <div id="gallery-prompt-visual" class="hidden sm:flex items-center space-x-1 pointer-events-none">
                 <div class="bounce-arrow">
                    &#8592; <!-- Right arrow unicode -->
                </div>
                <div id="gallery-prompt">
                    Explore Lessons!
                </div>
            </div>
        </div>
        <!-- END LEFT-SIDE -->

        <!-- Right-Side Button Cluster -->
        <div class="absolute top-4 right-4 flex gap-2">
            <button id="tutorial-btn" class="bg-gray-400 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-lg shadow-md">Tutorial</button>
            <button id="settings-btn" class="hidden auth-required bg-gray-700 hover:bg-gray-800 text-white font-bold py-2 px-4 rounded-lg shadow-md">Settings</button>
            <button id="login-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg shadow-md">Teacher Login</button>
            <button id="my-lessons-btn" class="hidden auth-required bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg shadow-md">My Lessons</button>
            <button id="logout-btn-home" class="hidden auth-required bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg shadow-md">Logout</button>
        </div>

        <h1 class="text-4xl font-bold text-blue-800 mb-6 mt-16">Coding Mat Generator</h1>
        <p1 class="text-2xl font-bold text-gray-800 mb-6 mt-16">Unboxing CT</p1>

        <div class="bg-white p-8 rounded-lg shadow-lg">
            <div class="grid grid-cols-2 gap-4 mb-4">
                <div>
                    <label for="rows-input" class="block text-sm font-medium text-gray-700 mb-1">Rows (1-10):</label>
                    <input type="number" id="rows-input" value="8" min="1" max="10" class="shadow-sm appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                </div>
                <div>
                    <label for="cols-input" class="block text-sm font-medium text-gray-700 mb-1">Cols (1-10):</label>
                    <input type="number" id="cols-input" value="8" min="1" max="10" class="shadow-sm appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                </div>
            </div>

             <div class="grid grid-cols-2 gap-4 mb-6">
                <div>
                    <label for="start-dir-select" class="block text-sm font-medium text-gray-700 mb-1">Start Direction:</label>
                    <select id="start-dir-select" class="shadow-sm appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                        <option value="0">Up</option>
                        <option value="1">Right</option>
                        <option value="2">Down</option>
                        <option value="3">Left</option>
                    </select>
                </div>
                <div>
                    <label for="change-bee-btn" class="block text-sm font-medium text-gray-700 mb-1">Custom Character:</label>
                    <button id="change-bee-btn" class="w-full bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg shadow-md text-sm">Upload Image</button>
                    <input type="file" id="bee-upload-input" class="hidden" accept="image/*">
                    <p id="bee-status" class="text-xs text-gray-500 mt-1 truncate">Default bee</p>
                </div>
            </div>

            <div class="flex flex-col gap-4">
                <div class="flex flex-wrap sm:flex-nowrap gap-4">
                    <button id="start-image-btn" class="w-full sm:flex-1 bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-4 rounded-lg shadow-md">Start Image Lesson</button>
                    <button id="start-text-btn" class="w-full sm:flex-1 bg-sky-500 hover:bg-sky-600 text-white font-bold py-3 px-4 rounded-lg shadow-md">Start Text Lesson</button>
                    <button id="start-ai-btn" class="w-full sm:flex-1 bg-purple-500 hover:bg-purple-600 text-white font-bold py-3 px-4 rounded-lg shadow-md">Start AI Lesson</button>
                </div>
                <button id="start-unbox-btn" class="w-full bg-cyan-500 hover:bg-cyan-600 text-white font-bold py-3 px-4 rounded-lg shadow-md">Start UNBOX Lesson (Image+Text+AI)</button>
            </div>
        </div>
    </div>

    <!-- Game View (Initially Hidden) -->
    <div id="game-page" class="w-full max-w-7xl mx-auto hidden h-full p-4">
        <div class="flex flex-col lg:flex-row gap-4 h-full">

            <!-- Column 1: Grid Section -->
            <div class="w-full lg:w-1/2 h-3/5 lg:h-full flex flex-col">
                 <div class="absolute top-2 right-2 z-20 flex gap-2">
                    <button id="settings-btn-game" class="hidden auth-required bg-gray-700 hover:bg-gray-800 text-white font-bold py-2 px-4 rounded-lg shadow-md">Settings</button>
                    <button id="logout-btn-game" class="hidden auth-required bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg shadow-md">Logout</button>
                 </div>
                 <input type="text" id="instruction-input" class="w-full text-3xl font-bold text-center text-gray-800 mb-4 p-2 rounded-lg shrink-0">
                <div class="flex-grow flex items-center justify-center overflow-hidden min-h-0 p-2">
                    <div id="grid-container" class="w-full lg:w-auto lg:h-full">
                        <canvas id="path-canvas"></canvas>
                        <div id="beebot"></div>
                    </div>
                </div>
                <!-- Slide Controls -->
                <div id="slide-controls" class="mt-4 p-4 bg-gray-200 rounded-lg flex items-center justify-center gap-4 flex-wrap shrink-0">
                    <button id="prev-slide-btn" class="slide-btn bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg shadow-md">&lt; Prev</button>
                    <span id="slide-counter" class="font-semibold text-lg">Slide 1 / 1</span>
                    <button id="next-slide-btn" class="slide-btn bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg shadow-md">Next &gt;</button>
                    <button id="add-slide-btn" class="slide-btn bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg shadow-md teacher-only">+</button>
                    <button id="delete-slide-btn" class="slide-btn bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg shadow-md teacher-only">Delete</button>
                </div>
            </div>

            <!-- Column 2: Controls Section -->
            <div class="w-full lg:w-1/4 h-auto lg:h-full bg-white p-6 rounded-lg shadow-lg flex flex-col">
                <div class="flex-grow">
                    <h2 class="text-2xl font-bold text-center text-gray-800 mb-4">Controls</h2>

                    <div class="grid grid-cols-3 gap-3 mb-4">
                        <div></div>
                        <button id="forward-btn" class="command-btn bg-blue-500 hover:bg-blue-600 text-white font-bold py-4 rounded-lg shadow-lg aspect-square flex items-center justify-center">
                            <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 10l7-7m0 0l7 7m-7-7v18"></path></svg>
                        </button>
                        <div></div>
                        <button id="left-btn" class="command-btn bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-4 rounded-lg shadow-lg aspect-square flex items-center justify-center">
                            <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg>
                        </button>
                         <button id="go-btn" class="command-btn bg-green-500 hover:bg-green-600 text-white font-bold py-4 rounded-lg shadow-lg aspect-square flex items-center justify-center">
                            GO
                        </button>
                        <button id="right-btn" class="command-btn bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-4 rounded-lg shadow-lg aspect-square flex items-center justify-center">
                            <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3"></path></svg>
                        </button>
                        <div></div>
                         <button id="backward-btn" class="command-btn bg-blue-500 hover:bg-blue-600 text-white font-bold py-4 rounded-lg shadow-lg aspect-square flex items-center justify-center">
                            <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 14l-7 7m0 0l-7-7m7 7V3"></path></svg>
                        </button>
                        <div></div>
                    </div>

                    <div class="grid grid-cols-2 gap-3">
                        <button id="clear-btn" class="command-btn bg-red-500 hover:bg-red-600 text-white font-bold py-3 px-4 rounded-lg shadow-lg">Clear</button>
                        <button id="stop-btn" class="command-btn bg-gray-500 hover:bg-gray-600 text-white font-bold py-3 px-4 rounded-lg shadow-lg">Stop</button>
                    </div>

                    <div class="mt-4 p-4 bg-gray-100 rounded-lg space-y-3">
                        <div>
                            <button id="change-bee-btn-game" class="w-full bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg shadow-md text-sm">Change Bee Character</button>
                            <input type="file" id="bee-upload-input-game" class="hidden" accept="image/*">
                        </div>

                        <!-- REMOVED THE STATIC POSITION INPUTS HERE (Lines 504-521 in the old file) -->
                        
                        <button id="set-pos-btn" class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg shadow-md text-sm teacher-only">Set Start Position</button>

                    </div>

                    <div class="mt-4 flex items-center justify-center gap-3 p-2 bg-gray-100 rounded-lg">
                        <label for="path-color-picker" class="text-sm font-semibold text-gray-700">Path Color:</label>
                        <input type="color" id="path-color-picker" value="#FF0000" class="w-10 h-10 border-none p-0 rounded-lg overflow-hidden cursor-pointer">
                    </div>
                </div>

                <!-- EDITED: This static panel is now permanently hidden -->
                <div id="text-edit-controls" class="mt-4 pt-4 border-t border-gray-200 teacher-only hidden">
                    <h3 class="font-semibold text-gray-700 mb-2">Edit Tile Text (for selected tile):</h3>
                    <div class="flex gap-2">
                        <input type="text" id="tile-text-input" class="shadow-sm appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" placeholder="Enter text...">
                        <button id="set-text-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg shadow-md">Set</button>
                    </div>
                    <div class="flex items-center gap-2 mt-2">
                        <span class="text-sm font-medium text-gray-700">Font Size (px):</span>
                        <button id="font-size-down" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold w-7 h-7 rounded-full shadow-md flex items-center justify-center">-</button>
                        <span id="current-font-size" class="text-sm font-semibold w-8 text-center">16</span>
                        <button id="font-size-up" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold w-7 h-7 rounded-full shadow-md flex items-center justify-center">+</button>
                    </div>
                </div>

                <div id="tile-edit-controls" class="mt-4 pt-4 border-t border-gray-200 teacher-only hidden">
                    <button id="clear-tile-btn" class="w-full bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg shadow-md">Clear Selected Tile</button>
                </div>
            </div>

            <!-- Column 3: Sequence Section -->
            <div class="w-full lg:w-1/4 flex-grow lg:flex-grow-0 lg:h-full bg-white p-6 rounded-lg shadow-lg flex flex-col min-h-0">
                <div class="flex-grow flex flex-col min-h-0">
                    <h3 class="font-semibold text-gray-700 mb-2 shrink-0">Command Sequence:</h3>
                    <div id="command-sequence" class="bg-gray-200 p-3 rounded-lg flex-grow overflow-y-auto flex flex-wrap gap-2 content-start"></div>
                </div>
                 <div id="student-controls" class="hidden w-full mt-4 space-y-2 shrink-0">
                     <button id="save-work-btn" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg shadow-md">Submit Work Online</button>
                     <button id="export-report-btn" class="w-full bg-purple-500 hover:bg-purple-600 text-white font-bold py-2 px-4 rounded-lg shadow-md">Export Final Report (PDF)</button>
                 </div>

                 <button id="save-lesson-btn" class="w-full mt-4 bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg shadow-md shrink-0 teacher-only hidden auth-required">Save Lesson Online</button>
                 <!-- REMOVED: Download Lesson (Offline) button -->
                 <button id="print-physical-mat-btn" class="w-full mt-2 bg-pink-500 hover:bg-pink-600 text-white font-bold py-2 px-4 rounded-lg shadow-md shrink-0 teacher-only">Print Physical Mat Tiles</button>
                 <button id="new-game-btn" class="w-full mt-2 bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg shadow-md shrink-0">Home</button>
            </div>

        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast-notification" class="fixed bottom-8 right-8 bg-green-500 text-white py-3 px-6 rounded-lg shadow-lg transition-all duration-300 opacity-0 translate-y-4 z-50">
        <span id="toast-message"></span>
    </div>

    <!-- For PDF Report Generation -->
    <div id="report-generator" class="hidden"></div>

    <!-- AI Image Generation Modal -->
    <div id="ai-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white p-6 rounded-lg shadow-lg w-full max-w-md">
            <h3 class="text-xl font-semibold mb-4">Generate AI Image for Tile</h3>
            <label for="ai-prompt-input" class="block text-gray-700 text-sm font-bold mb-2">Prompt:</label>
            <input type="text" id="ai-prompt-input" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" placeholder="e.g., 'a red apple', 'the letter A'">
            <div id="ai-modal-loader" class="hidden text-center my-4">
                <div class="inline-block w-8 h-8 border-4 border-blue-500 border-t-transparent rounded-full animate-spin"></div>
                <p class="text-gray-600 mt-2">Generating image... Please wait.</p>
            </div>
            <div class="flex justify-end gap-4 mt-6">
                <button id="ai-modal-cancel" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg shadow-md">Cancel</button>
                <button id="ai-modal-generate" class="bg-purple-500 hover:bg-purple-600 text-white font-bold py-2 px-4 rounded-lg shadow-md">Generate</button>
            </div>
        </div>
    </div>
    
    <!-- --- NEW: Text Edit Modal (Centralized Input) --- -->
    <div id="text-edit-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white p-6 rounded-lg shadow-lg w-full max-w-sm">
            <h3 class="text-xl font-semibold mb-4">Edit Tile Text</h3>
            
            <label for="text-modal-input" class="block text-gray-700 text-sm font-bold mb-2">Text for Tile:</label>
            <textarea id="text-modal-input" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline h-24" placeholder="Enter text..."></textarea>
            
            <div class="flex items-center justify-between gap-2 mt-4">
                <span class="text-sm font-medium text-gray-700">Font Size (px):</span>
                <div class="flex items-center gap-2">
                    <button id="text-modal-size-down" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold w-7 h-7 rounded-full shadow-md flex items-center justify-center">-</button>
                    <span id="text-modal-current-size" class="text-sm font-semibold w-8 text-center">16</span>
                    <button id="text-modal-size-up" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold w-7 h-7 rounded-full shadow-md flex items-center justify-center">+</button>
                </div>
            </div>
            
            <div class="flex justify-end gap-4 mt-6">
                <button id="text-modal-cancel" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg shadow-md">Cancel</button>
                <button id="text-modal-save" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg shadow-md">Save</button>
            </div>
        </div>
    </div>
    <!-- --- END NEW TEXT EDIT MODAL --- -->

    <!-- --- NEW: Set Position Modal (Position Inputs moved here) --- -->
    <div id="set-pos-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white p-6 rounded-lg shadow-lg w-full max-w-sm">
            <h3 class="text-xl font-semibold mb-4">Set Bee-Bot Start Position</h3>
            
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label for="pos-row-input" class="block font-semibold text-gray-700 mb-1">Row (1=Top):</label>
                    <!-- IMPORTANT: Using the existing input IDs -->
                    <input type="number" id="pos-row-input" min="1" class="shadow-sm appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                </div>
                <div>
                    <label for="pos-col-input" class="block font-semibold text-gray-700 mb-1">Column (1=Left):</label>
                    <!-- IMPORTANT: Using the existing input IDs -->
                    <input type="number" id="pos-col-input" min="1" class="shadow-sm appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                </div>
                <div class="col-span-2">
                    <label for="dir-select-input" class="block font-semibold text-gray-700 mb-1">Facing:</label>
                    <!-- IMPORTANT: Using the existing input IDs -->
                    <select id="dir-select-input" class="shadow-sm appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                        <option value="0">Up</option>
                        <option value="1">Right</option>
                        <option value="2">Down</option>
                        <option value="3">Left</option>
                    </select>
                </div>
            </div>
            
            <div class="flex justify-end gap-4 mt-6">
                <button id="set-pos-modal-cancel" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg shadow-md">Cancel</button>
                <button id="set-pos-modal-save" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg shadow-md">Set Position</button>
            </div>
        </div>
    </div>
    <!-- --- END NEW POSITION MODAL --- -->

    <!-- --- NEW: Tutorial Modal (with Collapsible Sections) --- -->
    <div id="tutorial-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white p-6 rounded-lg shadow-lg w-full max-w-xl max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4 sticky top-0 bg-white z-10 py-2 border-b">
                <h3 class="text-2xl font-bold text-gray-800">Application Tutorial</h3>
                <button id="close-tutorial-modal" class="text-gray-500 hover:text-gray-800 text-2xl">&times;</button>
            </div>
            
            <div class="space-y-2">
                
                <!-- Section: How to Start -->
                <details class="tutorial-details">
                    <summary>1. Getting Started & Creating a Lesson</summary>
                    <div class="tutorial-content text-gray-700">
                        <p class="mb-2">To unlock saving, sharing, and student tracking, first log in using your Gmail account via the Teacher Login button.</p>
                        <ul class="list-disc list-inside space-y-2">
                            <li><strong>Define Your Mat:</strong> Enter the desired number of Rows and Columns (110).</li>
                            <li><strong>Choose Your Lesson Type:</strong> Select the content mode that fits your needs:
                                <ul>
                                    <li><strong style="color: green;">Image Lesson:</strong> For uploading pictures to the tiles.</li>
                                    <li><strong style="color:  blue;">Text Lesson:</strong> For typing words or letters onto the tiles.</li>
                                    <li><strong style="color: violet;">AI Lesson:</strong> For generating unique images based on text prompts. (Requires API Key)</li>
                                    <li><strong style="color: blue green;">UNBOX Lesson (Recommended):</strong> Combines Image, Text, and AI generation features into one interface for maximum flexibility.</li>
                                </ul>
                            </li>
                            <li><strong>Start:</strong> Once satisfied with your settings, click the corresponding <strong>Start button.</strong> Don't worry about the character; you can <strong>change the Bee Character</strong> anytime within the editor.</li>
                        </ul>
                        <p class="mt-3 font-semibold text-red-600">
                            Important Reminder for AI: If you plan to generate images, you must first input your personal <strong>Google AI API Key</strong> in the <strong>Settings menu.</strong> Instructions on obtaining this key are provided within the Settings modal.
                        </p>
                    </div>
                </details>

                <!-- Section: How to Put Content in Tiles -->
                <details class="tutorial-details">
                    <summary>2. Adding Content and Setting Position</summary>
                    <div class="tutorial-content text-gray-700 space-y-2">
                        <p>To add content to the mat, simply <strong>click the desired tile</strong>. A pop-up will guide you based on your chosen Lesson Type (Upload, Type Text, or Generate AI).</p>
                        <p>To change the Bee-Bot's starting position, click the <strong>Set Start Position</strong> button in the Controls panel and enter the Row, Column, and Facing Direction.</p>
                    </div>
                </details>

                <!-- Section: How to Save Lesson -->
                <details class="tutorial-details">
                    <summary>3. Saving and Managing Your Lessons</summary>
                    <div class="tutorial-content text-gray-700 space-y-2">
                        <ul class="list-disc list-inside">
                            <li><strong style="color: green;">Save Online:</strong> When finished, click Save Lesson Online and give your lesson a name.</li>
                            <li><strong style="color: green;">Access Lessons:</strong> To view and manage your saved lessons, click the Home button, then click My Lessons.</li>
                        </ul>
                    </div>
                </details>

                <!-- Section: How to Share My Lesson -->
                <details class="tutorial-details">
                    <summary>4. Sharing Lessons with Students</summary>
                    <div class="tutorial-content text-gray-700">
                        <p>Go to <strong style="color: green;">My Lessons</strong>, find your lesson, and click <strong style="color: green;">Share</strong>. Copy the provided link to distribute to your students. </p>
                        <p class="font-semibold text-green-700">Students DO NOT need to log in; the link gives them direct access.</p>
                    </div>
                </details>

                <!-- Section: How to Check My Students Work -->
                <details class="tutorial-details">
                    <summary>5. Checking Student Submissions</summary>
                    <div class="tutorial-content text-gray-700">
                        <p>Go to <strong style="color: green;">My Lessons,</strong> find your shared mat, and click <strong style="color: green;">Submissions.</strong> Here you'll see a list of student work.</p>
                        <p>Clicking <strong style="color: green;">View Work</strong> will display the Mat and show a red line trace of the exact path the student's commands took. This lets you visually confirm if they achieved the goal. </p>
                        <p class="font-semibold text-orange-600">Reminder: Instruct students to enter their **initials or name** when submitting their work.</p>
                    </div>
                </details>

                <!-- Section: How to Share My Work with Other Teachers -->
                <details class="tutorial-details">
                    <summary>6. Sharing and Cloning Lessons with Colleagues</summary>
                    <div class="tutorial-content text-gray-700 space-y-2">
                        <ul class="list-disc list-inside">
                            <li><strong style="color: green;">Share with Teachers:</strong> In My Lessons, click Publish next to a shared mat. This adds your lesson to the <strong style="color: green;">Browse Gallery</strong>.</li>
                            <li><strong style="color: green;">Check Gallery:</strong> Click Browse Gallery on the Home screen to see lessons published by other teachers. You can click <strong style="color: green;">Clone</strong> next to any lesson to add a copy to your own My Lessons list.</li>
                        </ul>
                    </div>
                </details>

            </div>
            
            <div class="flex justify-end mt-6">
                <button id="close-tutorial-modal-footer" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg shadow-md">Got It</button>
            </div>
        </div>
    </div>
    <!-- --- END NEW TUTORIAL MODAL --- -->


    <!-- "My Lessons" Modal -->
    <div id="my-lessons-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white p-6 rounded-lg shadow-lg w-full max-w-lg">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-semibold">My Saved Lessons</h3>
                <button id="close-lessons-modal" class="text-gray-500 hover:text-gray-800 text-2xl">&times;</button>
            </div>
            <div id="my-lessons-list" class="max-h-96 overflow-y-auto space-y-2">
                <!-- Lessons will be dynamically loaded here -->
            </div>
        </div>
    </div>

    <!-- "Save Lesson" Modal -->
    <div id="save-lesson-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white p-6 rounded-lg shadow-lg w-full max-w-sm">
            <h3 class="text-xl font-semibold mb-4">Save Lesson</h3>
            <label for="lesson-name-input" class="block text-gray-700 text-sm font-bold mb-2">Lesson Name:</label>
            <input type="text" id="lesson-name-input" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" placeholder="My First Lesson">
            <div class="flex justify-end gap-4 mt-6">
                <button id="save-lesson-modal-cancel" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg shadow-md">Cancel</button>
                <button id="save-lesson-modal-save" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg shadow-md">Save</button>
            </div>
        </div>
    </div>

    <!-- "Share Link" Modal -->
    <div id="share-link-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white p-6 rounded-lg shadow-lg w-full max-w-lg">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-semibold">Share Lesson Link</h3>
                <button id="close-share-modal" class="text-gray-500 hover:text-gray-800 text-2xl">&times;</button>
            </div>
            <p class="text-gray-600 mb-2">Anyone with this link can view and play this lesson.</p>
            <div class="flex gap-2">
                <input type="text" id="share-link-input" readonly class="shadow-sm appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight bg-gray-100 focus:outline-none focus:shadow-outline">
                <button id="copy-link-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg shadow-md">Copy</button>
            </div>
        </div>
    </div>

    <!-- "Student Name" Modal -->
    <div id="student-name-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white p-6 rounded-lg shadow-lg w-full max-w-sm">
            <h3 class="text-xl font-semibold mb-4">Enter Your Name</h3>
            <p class="text-gray-600 mb-2">Please enter your name to submit your work.</p>
            <label for="student-name-input" class="block text-gray-700 text-sm font-bold mb-2">Your Name:</label>
            <input type="text" id="student-name-input" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" placeholder="Your Name">
            <div class="flex justify-end gap-4 mt-6">
                <button id="student-name-cancel" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg shadow-md">Cancel</button>
                <button id="student-name-submit" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg shadow-md">Submit</button>
            </div>
        </div>
    </div>

    <!-- "View Submissions" Modal -->
    <div id="submissions-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white p-6 rounded-lg shadow-lg w-full max-w-lg">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-semibold">Student Submissions for <span id="submissions-lesson-name" class="text-blue-600"></span></h3>
                <button id="close-submissions-modal" class="text-gray-500 hover:text-gray-800 text-2xl">&times;</button>
            </div>
            <div id="submissions-list" class="max-h-96 overflow-y-auto space-y-2">
                <!-- Submissions will be dynamically loaded here -->
            </div>
        </div>
    </div>

    <!-- "View Work" Modal -->
    <div id="view-work-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white p-6 rounded-lg shadow-lg w-full max-w-lg">
            <div class="flex justify-between items-center mb-4">
                <h3 id="view-work-student-name" class="text-xl font-semibold">Student's Work</h3>
                <button id="close-view-work-modal" class="text-gray-500 hover:text-gray-800 text-2xl">&times;</button>
            </div>
            
            <!-- VIZ FIX: New Slide Controls for Visualization -->
            <div id="view-work-slide-controls" class="flex items-center justify-center gap-4 p-2 bg-gray-100 rounded-lg mb-4 hidden">
                <button id="view-work-prev-slide" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-1 px-3 rounded-lg shadow-md">&lt; Prev</button>
                <span id="view-work-slide-counter" class="font-semibold text-sm">Slide 1 / 1</span>
                <button id="view-work-next-slide" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-1 px-3 rounded-lg shadow-md">Next &gt;</button>
            </div>

            <!-- VIZ: The Visualizer Grid (for Slide 1) -->
            <div class="relative max-w-lg mx-auto">
                <div id="view-work-loader" class="text-center my-4 absolute inset-0 bg-white/70 flex items-center justify-center z-10 hidden">
                    <div class="inline-block w-8 h-8 border-4 border-blue-500 border-t-transparent rounded-full animate-spin"></div>
                    <p class="text-gray-600 mt-16">Loading visualization...</p>
                </div>
                <div id="view-work-grid" class="hidden">
                    <!-- CRITICAL FIX: The canvas element now stays here to be used by JS -->
                    <canvas id="view-work-canvas"></canvas>
                </div>
            </div>

            <!-- VIZ: The Raw Commands (for all slides) -->
            <h4 class="text-lg font-semibold mt-4 mb-2">All Submitted Commands</h4>
            <pre id="view-work-content" class="max-h-48 overflow-y-auto space-y-2 bg-gray-100 p-4 rounded-md text-sm whitespace-pre-wrap"></pre>
        </div>
    </div>

    <!-- "Public Gallery" Modal -->
    <div id="public-gallery-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white p-6 rounded-lg shadow-lg w-full max-w-xl">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-semibold">Public Lesson Gallery</h3>
                <button id="close-gallery-modal" class="text-gray-500 hover:text-gray-800 text-2xl">&times;</button>
            </div>
            <div id="public-gallery-list" class="max-h-96 overflow-y-auto space-y-2">
                <!-- Public lessons will be dynamically loaded here -->
            </div>
        </div>
    </div>

    <!-- "Settings" Modal (BYOK) -->
    <div id="settings-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white p-6 rounded-lg shadow-lg w-full max-w-lg">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-semibold">Settings</h3>
                <button id="close-settings-modal" class="text-gray-500 hover:text-gray-800 text-2xl">&times;</button>
            </div>
            <div class="space-y-4">
                <div>
                    <label for="api-key-input" class="block text-sm font-medium text-gray-700 mb-1">Your Google AI API Key</label>
                    <input type="password" id="api-key-input" class="shadow-sm appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" placeholder="Enter your API key...">
                    <p class="text-xs text-gray-500 mt-1">
                        For generating AI images (AI and UNBOX mode). You can get a free key from
                        <a href="https://aistudio.google.com/app/apikey" target="_blank" class="text-blue-500 hover:underline">Google AI Studio</a>.
                    </p>
                    <p class="text-xs text-gray-500 mt-1">
                        Your key is saved securely to your private account and is never shared.
                    </p>
                </div>
                <div class="flex justify-end">
                    <button id="save-api-key-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg shadow-md">Save Key</button>
                </div>
            </div>
        </div>
    </div>

    <!-- "UNBOX Tile Choice" Modal -->
    <div id="tile-choice-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white p-6 rounded-lg shadow-lg w-full max-w-sm">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-semibold">Edit Tile</h3>
                <button id="choice-cancel-btn" class="text-gray-500 hover:text-gray-800 text-2xl">&times;</button>
            </div>
            <p class="text-gray-600 mb-4">What would you like to add to this tile?</p>
            <div class="space-y-3">
                <button id="choice-image-btn" class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-4 rounded-lg shadow-md">
                    Add/Change Image (Upload)
                </button>
                <button id="choice-text-btn" class="w-full bg-sky-500 hover:bg-sky-600 text-white font-bold py-3 px-4 rounded-lg shadow-md">
                    Add/Change Text
                </button>
                <button id="choice-ai-btn" class="w-full bg-purple-500 hover:bg-purple-600 text-white font-bold py-3 px-4 rounded-lg shadow-md">
                    Generate with AI
                </button>
            </div>
        </div>
    </div>


    <script>
        const { jsPDF } = window.jspdf;

        // --- GLOBAL APP LOGIC ---
        window.beebotApp = (function() {

            // --- DOM Elements ---
            const homePage = document.getElementById('home-page');
            const gamePage = document.getElementById('game-page');
            const startImageBtn = document.getElementById('start-image-btn');
            const startTextBtn = document.getElementById('start-text-btn');
            const startAiBtn = document.getElementById('start-ai-btn');
            const startUnboxBtn = document.getElementById('start-unbox-btn');
            const newGameBtn = document.getElementById('new-game-btn');
            const changeBeeBtn = document.getElementById('change-bee-btn');
            const beeUploadInput = document.getElementById('bee-upload-input');
            const beeStatus = document.getElementById('bee-status');
            const downloadOfflineBtn = document.getElementById('download-offline-btn');
            const printPhysicalMatBtn = document.getElementById('print-physical-mat-btn');
            const gridContainer = document.getElementById('grid-container');
            const beebot = document.getElementById('beebot');
            const commandSequenceDiv = document.getElementById('command-sequence');
            const stopBtn = document.getElementById('stop-btn');
            const textEditControls = document.getElementById('text-edit-controls');
            
            // --- UPDATED: References now point to the MODAL elements ---
            const textEditModal = document.getElementById('text-edit-modal');
            const tileTextInput = document.getElementById('text-modal-input');
            const textModalSaveBtn = document.getElementById('text-modal-save');
            const textModalCancelBtn = document.getElementById('text-modal-cancel');
            
            const fontSizeDownBtn = document.getElementById('font-size-down');
            const fontSizeUpBtn = document.getElementById('font-size-up');
            const currentFontSizeSpan = document.getElementById('current-font-size');
            
            // --- NEW: Modal Font Size Controls ---
            const textModalSizeDown = document.getElementById('text-modal-size-down');
            const textModalSizeUp = document.getElementById('text-modal-size-up');
            const textModalCurrentSize = document.getElementById('text-modal-current-size');
            
            // --- NEW: Position Modal Elements (These are now inside the modal) ---
            const posRowInput = document.getElementById('pos-row-input');
            const posColInput = document.getElementById('pos-col-input');
            const dirSelectInput = document.getElementById('dir-select-input');
            const setPosBtn = document.getElementById('set-pos-btn');
            const setPosModal = document.getElementById('set-pos-modal');
            const setPosModalCancel = document.getElementById('set-pos-modal-cancel');
            const setPosModalSave = document.getElementById('set-pos-modal-save');


            const tileEditControls = document.getElementById('tile-edit-controls');
            const clearTileBtn = document.getElementById('clear-tile-btn');

            const pathCanvas = document.getElementById('path-canvas');
            const pathCtx = pathCanvas.getContext('2d');
            const pathColorPicker = document.getElementById('path-color-picker');
            const instructionInput = document.getElementById('instruction-input');
            const slideControls = {
                prev: document.getElementById('prev-slide-btn'),
                next: document.getElementById('next-slide-btn'),
                counter: document.getElementById('slide-counter'),
                add: document.getElementById('add-slide-btn'),
                delete: document.getElementById('delete-slide-btn'),
            };
            const studentControls = document.getElementById('student-controls');
            const saveWorkBtn = document.getElementById('save-work-btn');
            const exportReportBtn = document.getElementById('export-report-btn');

            const changeBeeBtnGame = document.getElementById('change-bee-btn-game');
            const beeUploadInputGame = document.getElementById('bee-upload-input-game');

            const toast = document.getElementById('toast-notification');
            const toastMessage = document.getElementById('toast-message');
            const reportGenerator = document.getElementById('report-generator');

            const aiModal = document.getElementById('ai-modal');
            const aiPromptInput = document.getElementById('ai-prompt-input');
            const aiModalCancel = document.getElementById('ai-modal-cancel');
            const aiModalGenerate = document.getElementById('ai-modal-generate');
            const aiModalLoader = document.getElementById('ai-modal-loader');

            const backwardBtn = document.getElementById('backward-btn');

            const studentNameModal = document.getElementById('student-name-modal');
            const studentNameInput = document.getElementById('student-name-input');
            const studentNameCancel = document.getElementById('student-name-cancel');
            const studentNameSubmit = document.getElementById('student-name-submit');

            const tileChoiceModal = document.getElementById('tile-choice-modal');
            const choiceCancelBtn = document.getElementById('choice-cancel-btn');
            const choiceImageBtn = document.getElementById('choice-image-btn');
            const choiceTextBtn = document.getElementById('choice-text-btn');
            const choiceAIBtn = document.getElementById('choice-ai-btn');
            
            // --- NEW: Tutorial Modal Elements ---
            const tutorialBtn = document.getElementById('tutorial-btn');
            const tutorialModal = document.getElementById('tutorial-modal');
            const closeTutorialModalBtn = document.getElementById('close-tutorial-modal');
            const closeTutorialModalFooterBtn = document.getElementById('close-tutorial-modal-footer');

            // --- GALLERY PROMPT ELEMENTS ---
            const galleryPromptVisual = document.getElementById('gallery-prompt-visual');


            // --- Game State ---
            let commands = [];
            let beebotState = { row: 7, col: 0, dir: 0 }; // 0=N, 1=E, 2=S, 3=W
            let gridRows = 8;
            let gridCols = 8;
            let isExecuting = false;
            let selectedCell = null;
            let pathHistory = [];
            let gameMode = 'image'; // 'image', 'text', 'ai', 'unbox'
            let customBeeImageUrl = null;
            let isStudentMode = false;
            let studentWork = [];
            let studentName = null;
            let currentStudentLessonId = null;

            // --- Lesson State ---
            let lessonData = [];
            let currentSlideIndex = 0;

            const DEFAULT_FONT_SIZE = 16;
            const MIN_FONT_SIZE = 8;
            const MAX_FONT_SIZE = 48;
            const FONT_STEP = 2;

            let dragSourceCell = null;
            
            // --- VIZ FIX: Modal Slide Controls elements ---
            const viewWorkSlideControls = document.getElementById('view-work-slide-controls');
            const viewWorkPrevSlide = document.getElementById('view-work-prev-slide');
            const viewWorkNextSlide = document.getElementById('view-work-next-slide');
            const viewWorkSlideCounter = document.getElementById('view-work-slide-counter');


            // --- PHASE 2: STUDENT LESSON CHECK (Runs immediately) ---
            const urlParams = new URLSearchParams(window.location.search);
            const studentLessonId = urlParams.get('lesson');

            if (studentLessonId) {
                homePage.classList.add('hidden');
                currentStudentLessonId = studentLessonId;

                const checkFirebase = setInterval(() => {
                    // CRITICAL FIX: Ensure loadLessonSlides is available on firebaseServices
                    if (window.firebaseServices && window.firebaseServices.loadLessonSlides) {
                        clearInterval(checkFirebase);
                        loadStudentLessonFromShare(studentLessonId);
                    }
                }, 100);
            }

            // CRITICAL FIX: Function updated to fetch metadata AND slides from subcollection
            async function loadStudentLessonFromShare(lessonId) {
                const { db, appId, getDoc, doc } = window.firebaseServices;
                try {
                    const lessonDocPath = `artifacts/${appId}/public/data/shared-lessons/${lessonId}`;
                    const lessonDocRef = doc(db, lessonDocPath);
                    const lessonDoc = await getDoc(lessonDocRef);

                    if (lessonDoc.exists()) {
                        const lessonMetadata = lessonDoc.data();
                        
                        // VITAL: Fetch the slides from the subcollection
                        const lessonData = await window.firebaseServices.loadLessonSlides(lessonDocRef);
                        
                        // Reconstruct the full config object
                        const fullConfig = {
                            gameMode: lessonMetadata.gameMode,
                            customBeeImageUrl: lessonMetadata.customBeeImageUrl,
                            lessonData: lessonData
                        };

                        loadStudentLesson(fullConfig);
                    } else {
                        window.beebotApp.showToast("The lesson link is invalid or the lesson was deleted.", 4000);
                        homePage.classList.remove('hidden');
                    }
                } catch (err) {
                    console.error("Error loading shared lesson:", err);
                    window.beebotApp.showToast("There was an error loading the lesson.", 4000);
                    homePage.classList.remove('hidden');
                }
            }
            // --- END OF PHASE 2 CHECK ---

            // --- UI Functions ---
            let toastTimer;
            function showToast(message, duration = 3000) {
                toastMessage.textContent = message;
                toast.classList.remove('opacity-0', 'translate-y-4');
                toast.classList.add('opacity-100', 'translate-y-0');

                clearTimeout(toastTimer);
                toastTimer = setTimeout(() => {
                    toast.classList.add('opacity-0', 'translate-y-4');
                    toast.classList.remove('opacity-100', 'translate-y-0');
                }, duration);
            }

            // --- Homepage & Setup ---

            function handleBeeUpload(event) {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        customBeeImageUrl = e.target.result;
                        beeStatus.textContent = file.name;
                        beebot.style.backgroundImage = `url(${customBeeImageUrl})`;
                    }
                    reader.readAsDataURL(file);
                }
            }
            changeBeeBtn.addEventListener('click', () => beeUploadInput.click());
            beeUploadInput.addEventListener('change', handleBeeUpload);

            changeBeeBtnGame.addEventListener('click', () => beeUploadInputGame.click());
            beeUploadInputGame.addEventListener('change', handleBeeUpload);

            function startGame(mode) {
                gameMode = mode;
                isStudentMode = false;

                gridRows = parseInt(document.getElementById('rows-input').value, 10) || 8;
                gridCols = parseInt(document.getElementById('cols-input').value, 10) || 8;
                const startDir = parseInt(document.getElementById('start-dir-select').value, 10) || 0;

                const startRow = gridRows - 1;
                const startCol = 0;

                lessonData = [createLesson(gridRows, gridCols, startRow, startCol, startDir)];
                currentSlideIndex = 0;

                if (customBeeImageUrl) {
                    beebot.style.backgroundImage = `url(${customBeeImageUrl})`;
                }

                document.querySelectorAll('.teacher-only').forEach(el => el.classList.remove('hidden'));
                studentControls.classList.add('hidden');
                instructionInput.readOnly = false;

                posRowInput.disabled = false;
                posColInput.disabled = false;
                dirSelectInput.disabled = false;

                loadSlide(currentSlideIndex);

                homePage.classList.add('hidden');
                gamePage.classList.remove('hidden');
                gamePage.classList.add('flex');

                setTimeout(resizeCanvasAndPath, 50);
            }

            // CRITICAL FIX: Now accepts a parsed config object
            function loadStudentLesson(config) {
                gameMode = config.gameMode;
                isStudentMode = true;

                // config.lessonData is now guaranteed to be the parsed array of slide objects
                lessonData = config.lessonData; 

                currentSlideIndex = 0;
                studentWork = lessonData.map(() => []);

                if (config.customBeeImageUrl) {
                    customBeeImageUrl = config.customBeeImageUrl;
                    beebot.style.backgroundImage = `url(${customBeeImageUrl})`;
                }

                textEditControls.classList.add('hidden');
                document.querySelectorAll('.teacher-only').forEach(el => el.classList.add('hidden'));
                studentControls.classList.remove('hidden');

                posRowInput.disabled = true;
                posColInput.disabled = true;
                dirSelectInput.disabled = true;

                instructionInput.readOnly = true;

                saveWorkBtn.textContent = "Submit Work Online";

                loadSlide(currentSlideIndex);

                homePage.classList.add('hidden');
                gamePage.classList.remove('hidden');
                gamePage.classList.add('flex');

                setTimeout(resizeCanvasAndPath, 50);
            }

            // CRITICAL FIX: Now accepts a parsed config object
            function loadSavedLesson(config) {
                gameMode = config.gameMode;
                isStudentMode = false;

                // config.lessonData is now guaranteed to be the parsed array of slide objects
                lessonData = config.lessonData;

                currentSlideIndex = 0;
                studentWork = [];

                if (config.customBeeImageUrl) {
                    customBeeImageUrl = config.customBeeImageUrl;
                    beebot.style.backgroundImage = `url(${customBeeImageUrl})`;
                }

                document.querySelectorAll('.teacher-only').forEach(el => el.classList.remove('hidden'));
                studentControls.classList.add('hidden');
                instructionInput.readOnly = false;

                posRowInput.disabled = false;
                posColInput.disabled = false;
                dirSelectInput.disabled = false;

                loadSlide(currentSlideIndex);

                homePage.classList.add('hidden');
                gamePage.classList.remove('hidden');
                gamePage.classList.add('flex');

                setTimeout(resizeCanvasAndPath, 50);
            }

            function createLesson(rows, cols, startRow, startCol, startDir) {
                const gridData = Array.from({ length: rows }, () =>
                    Array.from({ length: cols }, () => ({
                        type: 'empty',
                        value: '',
                        id: crypto.randomUUID(),
                        fontSize: DEFAULT_FONT_SIZE
                    }))
                );

                return {
                    id: crypto.randomUUID(),
                    gridRows: rows,
                    gridCols: cols,
                    instruction: 'Program the Bee-Bot to reach the goal!',
                    initialBeebotState: {
                        row: startRow,
                        col: startCol,
                        dir: startDir,
                    },
                    gridData: gridData
                };
            }

            function loadSlide(index) {
                if (index < 0 || index >= lessonData.length) return;

                currentSlideIndex = index;
                const slide = lessonData[currentSlideIndex];

                gridRows = slide.gridRows;
                gridCols = slide.gridCols;
                instructionInput.value = slide.instruction;

                if (isStudentMode) {
                    commands = studentWork[currentSlideIndex] || [];
                } else {
                    commands = [];
                }

                // HIDE STATIC CONTROLS
                textEditControls.classList.add('hidden');
                tileEditControls.classList.add('hidden');
                // Ensure Modals are closed
                textEditModal.classList.add('hidden');
                setPosModal.classList.add('hidden');
                
                selectedCell = null;

                buildGridCells();
                stopExecution();
                updateSlideControls();
                updateCommandSequence();

                setTimeout(() => {
                    resizeCanvasAndPath();
                }, 50);
            }

            function updateCellUI(cell, cellData) {
                cell.innerHTML = '';
                cell.classList.remove('has-image');

                if (cellData.type === 'image') {
                    const img = document.createElement('img');
                    img.src = cellData.value;
                    cell.appendChild(img);
                    cell.classList.add('has-image');
                } else if (cellData.type === 'text') {
                    const textDiv = document.createElement('div');
                    textDiv.className = 'cell-text';
                    textDiv.textContent = cellData.value;
                    const fontSize = cellData.fontSize || DEFAULT_FONT_SIZE;
                    textDiv.style.fontSize = `${fontSize}px`;
                    cell.appendChild(textDiv);
                }
            }

            function buildGridCells() {
                gridContainer.innerHTML = '';
                gridContainer.appendChild(pathCanvas);
                gridContainer.appendChild(beebot);

                gridContainer.style.gridTemplateRows = `repeat(${gridRows}, 1fr)`;
                gridContainer.style.gridTemplateColumns = `repeat(${gridCols}, 1fr)`;

                const slideData = lessonData[currentSlideIndex].gridData;

                for (let r = 0; r < gridRows; r++) {
                    for (let c = 0; c < gridCols; c++) {
                        const cellData = slideData[r][c];
                        const cell = document.createElement('div');
                        cell.className = `grid-cell ${gameMode}-mode`;
                        cell.dataset.row = r;
                        cell.dataset.col = c;
                        cell.dataset.id = cellData.id;

                        cell.setAttribute('draggable', 'true');
                        cell.addEventListener('dragstart', handleDragStart);
                        cell.addEventListener('dragover', handleDragOver);
                        cell.addEventListener('drop', handleDrop);
                        cell.addEventListener('dragend', handleDragEnd);

                        updateCellUI(cell, cellData);

                        cell.addEventListener('click', () => handleCellClick(cell, r, c));
                        gridContainer.appendChild(cell);
                    }
                }

                if (isStudentMode) {
                    gridContainer.querySelectorAll('.grid-cell').forEach(el => {
                        el.classList.add('student-mode');
                        el.setAttribute('draggable', 'false');
                    });
                }
            }

            // --- DRAG-N-DROP: Event Handlers ---
            function handleDragStart(e) {
                const cell = e.target;
                const row = cell.dataset.row;
                const col = cell.dataset.col;
                const cellData = lessonData[currentSlideIndex].gridData[row][col];

                if (isStudentMode || (cellData.type !== 'image' && cellData.type !== 'text')) {
                    e.preventDefault();
                    return;
                }

                dragSourceCell = cell;
                e.dataTransfer.effectAllowed = 'move';
                e.dataTransfer.setData('text/plain', `${row},${col}`);

                setTimeout(() => cell.classList.add('dragging'), 0);
            }

            function handleDragOver(e) {
                e.preventDefault();
                e.dataTransfer.dropEffect = 'move';
            }

            function handleDrop(e) {
                e.preventDefault();
                e.stopPropagation();

                if (isStudentMode || !dragSourceCell) return;

                const targetCell = e.target.closest('.grid-cell');
                if (!targetCell || targetCell === dragSourceCell) return;

                const [sourceRow, sourceCol] = e.dataTransfer.getData('text/plain').split(',');
                const sourceCellData = lessonData[currentSlideIndex].gridData[sourceRow][sourceCol];

                const targetRow = targetCell.dataset.row;
                const targetCol = targetCell.dataset.col;
                const targetCellData = lessonData[currentSlideIndex].gridData[targetRow][targetCol];

                // Swap the data
                lessonData[currentSlideIndex].gridData[sourceRow][sourceCol] = targetCellData;
                lessonData[currentSlideIndex].gridData[targetRow][targetCol] = sourceCellData;

                // Update the UI
                updateCellUI(dragSourceCell, targetCellData);
                updateCellUI(targetCell, sourceCellData);

                // Deselect the cell if it was selected
                if (dragSourceCell === selectedCell || targetCell === selectedCell) {
                    selectedCell?.classList.remove('selected');
                    selectedCell = null;
                    textEditControls.classList.add('hidden');
                    tileEditControls.classList.add('hidden');
                }
            }

            function handleDragEnd(e) {
                dragSourceCell?.classList.remove('dragging');
                dragSourceCell = null;
            }
            // --- END OF DRAG-N-DROP Handlers ---

            // --- NEW: Text Edit Modal Opening Function ---
            function openTextEditModal(row, col) {
                // Ensure text edit controls are fully hidden before showing modal
                textEditControls.classList.add('hidden'); 
                
                const cellData = lessonData[currentSlideIndex].gridData[row][col];
                const currentText = cellData.type === 'text' ? cellData.value : '';
                const currentSize = cellData.fontSize || DEFAULT_FONT_SIZE;
                
                textEditModal.dataset.row = row;
                textEditModal.dataset.col = col;
                
                tileTextInput.value = currentText;
                textModalCurrentSize.textContent = currentSize;
                
                textEditModal.classList.remove('hidden');
                tileTextInput.focus();
                
                // Also ensures the "Clear Tile" button is visible when editing text
                tileEditControls.classList.remove('hidden');
            }
            
            function handleCellClick(cell, row, col) {
                if (isStudentMode) return;

                // Always hide modals and static controls first
                textEditModal.classList.add('hidden');
                tileChoiceModal.classList.add('hidden');
                setPosModal.classList.add('hidden'); // Ensure position modal is closed
                tileEditControls.classList.add('hidden');
                
                if (selectedCell) {
                    selectedCell.classList.remove('selected');
                }

                if (selectedCell === cell) {
                    selectedCell = null;
                    return;
                }

                selectedCell = cell;
                selectedCell.classList.add('selected');
                
                const cellData = lessonData[currentSlideIndex].gridData[row][col];

                if (gameMode === 'image') {
                    if (cellData.type === 'empty') {
                        openImageUploader(row, col);
                    } else {
                        // If cell has image, clicking just selects it (for "Clear" or drag)
                        tileEditControls.classList.remove('hidden');
                    }
                    
                } else if (gameMode === 'text') {
                    // FIX: Open the centralized modal instead of showing the static panel
                    openTextEditModal(row, col);

                } else if (gameMode === 'ai') {
                    if (cellData.type === 'empty') {
                        openAIModal(row, col);
                    } else {
                        tileEditControls.classList.remove('hidden');
                    }

                } else if (gameMode === 'unbox') {
                    // In UNBOX mode, ALWAYS open the choice modal
                    tileChoiceModal.dataset.row = row;
                    tileChoiceModal.dataset.col = col;
                    tileChoiceModal.classList.remove('hidden');
                    tileEditControls.classList.remove('hidden');
                }
            }
            
            // --- UNBOX Helper functions ---
            function openImageUploader(row, col) {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = 'image/*';
                input.onchange = (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = (event) => {
                            const imageUrl = event.target.result;
                            const cellData = lessonData[currentSlideIndex].gridData[row][col];
                            cellData.type = 'image';
                            cellData.value = imageUrl;
                            cellData.fontSize = DEFAULT_FONT_SIZE;

                            const cell = gridContainer.querySelector(`.grid-cell[data-row='${row}'][data-col='${col}']`);
                            updateCellUI(cell, cellData);
                        };
                        reader.readAsDataURL(file);
                    }
                };
                input.click();
            }

            function openTextEditor(row, col) {
                // Reroutes to the new modal function
                openTextEditModal(row, col);
            }

            function openAIModal(row, col) {
                aiPromptInput.value = '';
                aiModal.classList.remove('hidden');
                aiModalGenerate.dataset.row = row;
                aiModalGenerate.dataset.col = col;
                aiPromptInput.focus();
            }
            // --- End of UNBOX helpers ---

            function updateSlideControls() {
                slideControls.counter.textContent = `Slide ${currentSlideIndex + 1} / ${lessonData.length}`;
                slideControls.prev.disabled = (currentSlideIndex === 0);
                slideControls.next.disabled = (currentSlideIndex === lessonData.length - 1);
                slideControls.delete.disabled = (lessonData.length <= 1);
            }

            // --- Command Functions ---

            function addCommand(cmd) {
                if (isExecuting) return;
                commands.push(cmd);
                updateCommandSequence();
            }

            function updateCommandSequence() {
                commandSequenceDiv.innerHTML = '';
                commands.forEach(cmd => {
                    const cmdIcon = document.createElement('div');
                    cmdIcon.className = 'w-10 h-10 flex items-center justify-center rounded-md text-gray-800 font-bold text-xl shadow-sm';
                    let svg = '';
                    switch(cmd) {
                        case 'F':
                            svg = '<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 10l7-7m0 0l7 7m-7-7v18"></path></svg>';
                            cmdIcon.classList.add('bg-blue-200');
                            break;
                        case 'L':
                            svg = '<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg>';
                            cmdIcon.classList.add('bg-yellow-200');
                            break;
                        case 'R':
                            svg = '<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3"></path></svg>';
                            cmdIcon.classList.add('bg-yellow-200');
                            break;
                        case 'B':
                            svg = '<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 14l-7 7m0 0l-7-7m7 7V3"></path></svg>';
                            cmdIcon.classList.add('bg-blue-200');
                            break;
                    }
                    cmdIcon.innerHTML = svg;
                    commandSequenceDiv.appendChild(cmdIcon);
                });
            }

            function resetBeeToStart() {
                const initialState = lessonData[currentSlideIndex].initialBeebotState;
                beebotState = { ...initialState };
                pathHistory = [{ ...beebotState }];
                updateBeebotPosition();
                updateBeeBotInfo();
                redrawFullPath();
            }

            function stopExecution() {
                isExecuting = false;
                document.getElementById('go-btn').disabled = false;
                resetBeeToStart();
            }

            async function executeCommands() {
                if (isExecuting) return;
                isExecuting = true;
                document.getElementById('go-btn').disabled = true;

                resetBeeToStart();
                await new Promise(resolve => setTimeout(resolve, 50));

                try {
                    for (const cmd of commands) {
                        if (!isExecuting) break;

                        const oldPos = { ...beebotState };
                        let moved = false;
                        let waitTime = 500;

                        switch(cmd) {
                            case 'F':
                                let newRow = oldPos.row;
                                let newCol = oldPos.col;
                                if (oldPos.dir === 0) newRow--;
                                if (oldPos.dir === 1) newCol++;
                                if (oldPos.dir === 2) newRow++;
                                if (oldPos.dir === 3) newCol--;

                                if (newRow >= 0 && newRow < gridRows && newCol >= 0 && newCol < gridCols) {
                                    beebotState.row = newRow;
                                    beebotState.col = newCol;
                                    moved = true;
                                }
                                break;
                            case 'B':
                                let backRow = oldPos.row;
                                let backCol = oldPos.col;
                                if (oldPos.dir === 0) backRow++;
                                if (oldPos.dir === 1) backCol--;
                                if (oldPos.dir === 2) backRow--;
                                if (oldPos.dir === 3) backCol++;

                                if (backRow >= 0 && backRow < gridRows && backCol >= 0 && backCol < gridCols) {
                                    beebotState.row = backRow;
                                    beebotState.col = backCol;
                                    moved = true;
                                }
                                break;
                            case 'L':
                                beebotState.dir = (oldPos.dir + 3) % 4;
                                break;
                            case 'R':
                                beebotState.dir = (oldPos.dir + 1) % 4;
                                break;
                        }

                        updateBeebotPosition();
                        await new Promise(resolve => setTimeout(resolve, waitTime));

                        if (moved) {
                            pathHistory.push({ ...beebotState });
                            redrawFullPath();
                        }

                        updateBeeBotInfo();
                    }
                } catch (err) {
                    console.error("Error during command execution:", err);
                    showToast("An error occurred during execution.", 3000);
                } finally {
                    isExecuting = false;
                    document.getElementById('go-btn').disabled = false;
                }
            }

            // --- REMOVED: saveLessonOffline function ---
            /*
            function saveLessonOffline() {
                // Removed the entire function body as requested
            }
            */

            // --- Function to generate PDF for physical mat ---
            async function generatePhysicalMatPDF() {
                if (isStudentMode) {
                    window.beebotApp.showToast("This feature is for teachers only.", 2000);
                    return;
                }

                showToast('Generating Physical Mat PDF... This may take a moment.', 5000);

                const pdf = new jsPDF({
                    orientation: 'portrait',
                    unit: 'in',
                    format: 'letter'
                });

                const pageWidth = 8.5;
                const pageHeight = 11;
                const margin = 0.5;
                const tileWidth = 5;
                const tileHeight = 5;
                const xPos = (pageWidth - tileWidth) / 2;
                const yPosTop = margin;
                const yPosBottom = margin + tileWidth + margin; // Corrected to use tileWidth for initial vertical offset

                let tileIndex = 0;

                for (let i = 0; i < lessonData.length; i++) {
                    const slide = lessonData[i];
                    const gridData = slide.gridData.flat();

                    for (const cellData of gridData) {
                        if (cellData.type === 'empty') {
                            continue;
                        }

                        let yPos;
                        if (tileIndex % 2 === 0) {
                            if (tileIndex > 0) {
                                pdf.addPage();
                            }
                            yPos = yPosTop;
                        } else {
                            yPos = yPosBottom;
                        }

                        pdf.setDrawColor(200, 200, 200);
                        pdf.setLineWidth(0.01);
                        pdf.rect(xPos, yPos, tileWidth, tileHeight);

                        if (cellData.type === 'image') {
                            try {
                                pdf.addImage(cellData.value, 'PNG', xPos, yPos, tileWidth, tileHeight);
                            } catch (e) {
                                console.error("Error adding image to PDF:", e);
                                pdf.setFontSize(10);
                                pdf.setTextColor(255, 0, 0);
                                pdf.text("Error loading image", xPos + 0.1, yPos + 0.1);
                                pdf.setTextColor(0, 0, 0);
                            }
                        } else if (cellData.type === 'text') {
                            const text = cellData.value;
                            const fontSize = cellData.fontSize || DEFAULT_FONT_SIZE;

                            const fontSizeInPoints = fontSize * 0.75;
                            pdf.setFontSize(fontSizeInPoints);
                            pdf.setFont('helvetica', 'normal');

                            const textLines = pdf.splitTextToSize(text, tileWidth - (margin * 2));

                            const textBlockHeight = (textLines.length * fontSizeInPoints) / 72;
                            const textYCenter = yPos + (tileHeight / 2) - (textBlockHeight / 2);

                            pdf.text(textLines, xPos + (tileWidth / 2), textYCenter, {
                                align: 'center',
                                baseline: 'top'
                            });
                        }

                        tileIndex++;
                    }
                }

                if (tileIndex === 0) {
                    showToast('No content found on the mat to print.', 3000);
                } else {
                    pdf.save('beebot-physical-mat-tiles.pdf');
                    showToast('Physical Mat PDF has been downloaded!', 3000);
                }
            }

            // --- AI Generation Functions ---
            async function generateAiImage() {
                const prompt = aiPromptInput.value;
                if (!prompt) {
                    window.beebotApp.showToast("Please enter a prompt.", 2000);
                    return;
                }

                const { row, col } = aiModalGenerate.dataset;

                aiModalLoader.classList.remove('hidden');
                aiModalGenerate.disabled = true;
                aiPromptInput.disabled = true;

                try {
                    const { getApiKey } = window.firebaseServices;
                    const userApiKey = await getApiKey();

                    if (!userApiKey) {
                        window.beebotApp.showToast("Add your Google AI API key in 'Settings'.", 3000);
                        aiModal.classList.add('hidden');
                        return;
                    }

                    const apiKey = userApiKey;
                    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/imagen-3.0-generate-002:predict?key=${apiKey}`;

                    const payload = {
                        instances: { prompt: prompt },
                        parameters: { "sampleCount": 1 }
                    };

                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        const errorBody = await response.text();
                        console.error("API Error Response:", errorBody);
                        throw new Error(`Google API error: ${response.status} ${response.statusText}. Check your API key and prompt.`);
                    }

                    const result = await response.json();

                    if (result.predictions && result.predictions.length > 0 && result.predictions[0].bytesBase64Encoded) {
                        const imageUrl = `data:image/png;base64,${result.predictions[0].bytesBase64Encoded}`;

                        const cellData = lessonData[currentSlideIndex].gridData[row][col];
                        cellData.type = 'image';
                        cellData.value = imageUrl;
                        cellData.fontSize = DEFAULT_FONT_SIZE;

                        const cell = gridContainer.querySelector(`.grid-cell[data-row='${row}'][data-col='${col}']`);
                        if (cell) {
                            updateCellUI(cell, cellData);
                        }
                        aiModal.classList.add('hidden');
                    } else {
                        throw new Error("Invalid API response format or no image generated.");
                    }
                } catch (error) {
                    console.error("AI Image Generation Error:", error);
                    window.beebotApp.showToast(`Failed to generate image: ${error.message}`, 5000);
                } finally {
                    aiModalLoader.classList.add('hidden');
                    aiModalGenerate.disabled = false;
                    aiPromptInput.disabled = false;
                }
            }

            // --- Student Mode Functionality ---
            saveWorkBtn.addEventListener('click', () => {
                studentWork[currentSlideIndex] = [...commands];
                showToast(`Work saved for Slide ${currentSlideIndex + 1}!`, 2000);

                if (!studentName) {
                    studentNameModal.classList.remove('hidden');
                    studentNameInput.focus();
                } else {
                    submitStudentWork();
                }
            });

            studentNameCancel.addEventListener('click', () => {
                studentNameModal.classList.add('hidden');
            });

            studentNameSubmit.addEventListener('click', () => {
                const name = studentNameInput.value.trim();
                if (name) {
                    studentName = name;
                    studentNameModal.classList.add('hidden');
                    submitStudentWork();
                } else {
                    window.beebotApp.showToast("Please enter your name.", 2000);
                }
            });

            async function submitStudentWork() {
                if (!isStudentMode || !currentStudentLessonId || !studentName) {
                    console.error("Missing data for submission");
                    return;
                }

                showToast("Submitting your work...", 2000);

                const { db, appId, addDoc, collection, getAuth } = window.firebaseServices;

                try {
                    const auth = getAuth();
                    const userId = auth.currentUser ? auth.currentUser.uid : 'anonymous-' + crypto.randomUUID();

                    const submissionsCollectionPath = `artifacts/${appId}/public/data/student-submissions`;

                    const docRef = await addDoc(collection(db, submissionsCollectionPath), {
                        studentName: studentName,
                        studentId: userId,
                        lessonId: currentStudentLessonId,
                        work: JSON.stringify(studentWork),
                        submittedAt: new Date().toISOString()
                    });

                    console.log("Work submitted with ID:", docRef.id);
                    showToast("Work submitted successfully!", 3000);

                } catch (e) {
                    console.error("Error submitting work:", e);
                    showToast("Error submitting work.", 3000);
                }
            }

            exportReportBtn.addEventListener('click', async () => {
                showToast('Generating report... Please wait.', 5000);

                reportGenerator.innerHTML = '';
                reportGenerator.classList.remove('hidden');

                const pdf = new jsPDF({
                    orientation: 'portrait',
                    unit: 'px',
                    format: 'a4'
                });

                const pageWidth = pdf.internal.pageSize.getWidth();
                const pageHeight = pdf.internal.pageSize.getHeight();
                const margin = 20;
                const usableWidth = pageWidth - (margin * 2);
                let yPos = margin;

                pdf.setFontSize(22);
                pdf.setFont('helvetica', 'bold');
                pdf.text("Bee-Bot Lesson Report", pageWidth / 2, yPos, { align: 'center' });
                yPos += 30;

                pdf.setFontSize(12);
                pdf.setFont('helvetica', 'normal');
                pdf.text(`Student: ${studentName || '(Student Name)'}`, margin, yPos);
                pdf.text(`Date: ${new Date().toLocaleDateString()}`, pageWidth - margin, yPos, { align: 'right' });
                yPos += 20;

                for (let i = 0; i < lessonData.length; i++) {
                    const slide = lessonData[i];
                    const work = studentWork[i] || [];

                    const sectionHeight = 250;
                    if (yPos + sectionHeight > pageHeight - margin) {
                        pdf.addPage();
                        yPos = margin;
                    }

                    pdf.setFontSize(16);
                    pdf.setFont('helvetica', 'bold');
                    pdf.text(`Slide ${i + 1}: ${slide.instruction}`, margin, yPos);
                    yPos += 20;

                    const tempGrid = document.createElement('div');
                    tempGrid.id = 'temp-grid';
                    tempGrid.style.width = '800px';
                    tempGrid.style.height = '800px';
                    tempGrid.style.position = 'absolute';
                    tempGrid.style.left = '-9999px';
                    reportGenerator.appendChild(tempGrid);

                    tempGrid.style.display = 'grid';
                    tempGrid.style.gridTemplateRows = `repeat(${slide.gridRows}, 1fr)`;
                    tempGrid.style.gridTemplateColumns = `repeat(${slide.gridCols}, 1fr)`;
                    tempGrid.style.border = '2px solid #333';

                    slide.gridData.flat().forEach(cellData => {
                        const cell = document.createElement('div');
                        cell.className = 'grid-cell';
                        cell.style.border = '1px solid #ccc';
                        cell.style.width = `${800 / slide.gridCols}px`;
                        cell.style.height = `${800 / slide.gridRows}px`;

                        if (cellData.type === 'image') {
                            const img = document.createElement('img');
                            img.src = cellData.value;
                            img.style.width = '100%';
                            img.style.height = '100%';
                            img.style.objectFit = 'cover';
                            cell.appendChild(img);
                        } else if (cellData.type === 'text') {
                            cell.textContent = cellData.value;
                            cell.style.fontSize = `${cellData.fontSize || DEFAULT_FONT_SIZE}px`;
                            cell.style.display = 'flex';
                            cell.style.alignItems = 'center';
                            cell.style.justifyContent = 'center';
                            cell.style.wordBreak = 'break-word';
                        }
                        tempGrid.appendChild(cell);
                    });

                    const tempCanvas = document.createElement('canvas');
                    tempCanvas.width = 800;
                    tempCanvas.height = 800;
                    tempCanvas.style.position = 'absolute';
                    tempCanvas.style.top = '0';
                    tempCanvas.style.left = '0';
                    tempGrid.appendChild(tempCanvas);

                    const tempCtx = tempCanvas.getContext('2d');
                    tempCtx.strokeStyle = pathColorPicker.value;
                    tempCtx.lineWidth = 5;
                    tempCtx.lineCap = 'round';
                    tempCtx.lineJoin = 'round';

                    let pathSimState = { ...slide.initialBeebotState };
                    const cellW = 800 / slide.gridCols;
                    const cellH = 800 / slide.gridRows;

                    tempCtx.beginPath();
                    tempCtx.moveTo(pathSimState.col * cellW + cellW / 2, pathSimState.row * cellH + cellH / 2);

                    for (const cmd of work) {
                        if (cmd === 'F') {
                            let newRow = pathSimState.row;
                            let newCol = pathSimState.col;
                            if (pathSimState.dir === 0) newRow--;
                            if (pathSimState.dir === 1) newCol++;
                            if (pathSimState.dir === 2) newRow++;
                            if (pathSimState.dir === 3) newCol--;

                            if (newRow >= 0 && newRow < slide.gridRows && newCol >= 0 && newCol < slide.gridCols) {
                                pathSimState.row = newRow;
                                pathSimState.col = newCol;
                                tempCtx.lineTo(pathSimState.col * cellW + cellW / 2, pathSimState.row * cellH + cellH / 2);
                            }
                        } else if (cmd === 'B') {
                            let backRow = pathSimState.row;
                            let backCol = pathSimState.col;
                            if (pathSimState.dir === 0) backRow++;
                            if (pathSimState.dir === 1) backCol--;
                            if (pathSimState.dir === 2) backRow--;
                            if (pathSimState.dir === 3) backCol++;

                            if (backRow >= 0 && backRow < slide.gridRows && backCol >= 0 && backCol < slide.gridCols) {
                                pathSimState.row = backRow;
                                pathSimState.col = backCol;
                                tempCtx.lineTo(pathSimState.col * cellW + cellW / 2, pathSimState.row * cellH + cellH / 2);
                            }
                        } else if (cmd === 'L') {
                            pathSimState.dir = (pathSimState.dir + 3) % 4;
                        } else if (cmd === 'R') {
                            pathSimState.dir = (pathSimState.dir + 1) % 4;
                        }
                    }
                    tempCtx.stroke();

                    try {
                        const canvas = await html2canvas(tempGrid, { useCORS: true, scale: 1 });
                        const imgData = canvas.toDataURL('image/png');

                        const imgSize = usableWidth * 0.6;
                        pdf.addImage(imgData, 'PNG', margin, yPos, imgSize, imgSize);

                        const commandsX = margin + imgSize + 15;
                        const commandsWidth = usableWidth - imgSize - 15;
                        pdf.setFontSize(10);
                        pdf.setFont('helvetica', 'bold');
                        pdf.text('Commands Used:', commandsX, yPos);
                        yPos += 12;

                        pdf.setFont('helvetica', 'normal');
                        if (work.length > 0) {
                            const cmdStr = work.join(', ');
                            const splitCmds = pdf.splitTextToSize(cmdStr, commandsWidth);
                            pdf.text(splitCmds, commandsX, yPos);
                            yPos += (splitCmds.length * 10);
                        } else {
                            pdf.text('No commands saved.', commandsX, yPos);
                            yPos += 10;
                        }

                        yPos = margin + imgSize + 20;

                    } catch (e) {
                        console.error("html2canvas error:", e);
                        pdf.setFont('helvetica', 'normal');
                        pdf.text('Error generating grid image.', margin, yPos, { color: 'red' });
                        yPos += 20;
                    }

                    reportGenerator.innerHTML = '';

                    yPos += 10;
                }

                pdf.save('beebot-report.pdf');
                reportGenerator.classList.add('hidden');
            });


            // --- Path Drawing ---
            function resizeCanvasAndPath() {
                const rect = gridContainer.getBoundingClientRect();
                pathCanvas.width = rect.width;
                pathCanvas.height = rect.height;
                updateBeebotPosition();
                redrawFullPath();
            }

            function updateBeebotPosition(pos = beebotState) {
                if (!gridContainer.offsetWidth || !gridContainer.offsetHeight) return;

                const cellWidth = gridContainer.offsetWidth / gridCols;
                const cellHeight = gridContainer.offsetHeight / gridRows;

                beebot.style.width = `${cellWidth}px`;
                beebot.style.height = `${cellHeight}px`;
                beebot.style.top = `${pos.row * cellHeight}px`;
                beebot.style.left = `${pos.col * cellWidth}px`;

                const visualRotation = (pos.dir * 90) - 90;
                beebot.style.transform = `rotate(${visualRotation}deg)`;
            }

            function updateBeeBotInfo() {
                posRowInput.value = gridRows - beebotState.row;
                posColInput.value = beebotState.col + 1;
                dirSelectInput.value = beebotState.dir;
            }

            function redrawFullPath() {
                pathCtx.clearRect(0, 0, pathCanvas.width, pathCanvas.height);
                if (pathHistory.length < 1) return;

                const cellWidth = pathCanvas.width / gridCols;
                const cellHeight = pathCanvas.height / gridRows;

                pathCtx.strokeStyle = pathColorPicker.value;
                pathCtx.lineWidth = Math.max(5, cellWidth * 0.1);
                pathCtx.lineCap = 'round';
                pathCtx.lineJoin = 'round';

                const startPos = pathHistory[0];
                pathCtx.beginPath();
                pathCtx.moveTo(startPos.col * cellWidth + cellWidth / 2, startPos.row * cellHeight + cellHeight / 2);

                for (let i = 1; i < pathHistory.length; i++) {
                    const pos = pathHistory[i];
                    pathCtx.lineTo(pos.col * cellWidth + cellWidth / 2, pos.row * cellHeight + cellHeight / 2);
                }
                pathCtx.stroke();

                pathCtx.fillStyle = 'green';
                pathCtx.beginPath();
                pathCtx.arc(startPos.col * cellWidth + cellWidth / 2, startPos.row * cellHeight + cellHeight / 2, pathCtx.lineWidth, 0, 2 * Math.PI);
                pathCtx.fill();

                if (pathHistory.length > 1) {
                    const endPos = pathHistory[pathHistory.length - 1];
                    pathCtx.fillStyle = pathColorPicker.value;
                    pathCtx.beginPath();
                    pathCtx.arc(endPos.col * cellWidth + cellWidth / 2, endPos.row * cellHeight + cellHeight / 2, pathCtx.lineWidth, 0, 2 * Math.PI);
                    pathCtx.fill();
                }
            }

            // --- Font Size Change Function (for MODAL) ---
            function changeTextModalFontSize(direction) {
                // Get the current size from the modal span
                let currentSize = parseInt(textModalCurrentSize.textContent, 10);
                
                // Determine if we are increasing or decreasing (1 or -1)
                const step = direction * FONT_STEP;
                currentSize += step;

                // Clamp the size to stay within limits
                currentSize = Math.max(MIN_FONT_SIZE, Math.min(MAX_FONT_SIZE, currentSize));
                
                // Update the modal span
                textModalCurrentSize.textContent = currentSize;
                
                // Optional: Provide visual feedback in the text area (CSS style if supported)
                tileTextInput.style.fontSize = `${currentSize}px`;
            }
            
            // --- Event Listeners for Text Modal ---
            textModalCancelBtn.addEventListener('click', () => {
                textEditModal.classList.add('hidden');
                selectedCell?.classList.remove('selected');
                selectedCell = null;
                tileEditControls.classList.add('hidden');
            });
            
            textModalSaveBtn.addEventListener('click', () => {
                if (!selectedCell) return;
                
                const row = textEditModal.dataset.row;
                const col = textEditModal.dataset.col;
                const text = tileTextInput.value;
                const currentSize = parseInt(textModalCurrentSize.textContent, 10);
                
                const cellData = lessonData[currentSlideIndex].gridData[row][col];
                
                // 1. Update the data object
                cellData.type = 'text';
                cellData.value = text;
                cellData.fontSize = currentSize;
                
                // 2. Update the UI
                updateCellUI(selectedCell, cellData);
                
                // 3. Clean up
                textEditModal.classList.add('hidden');
                selectedCell.classList.remove('selected');
                selectedCell = null;
                tileEditControls.classList.add('hidden');
                
                showToast('Tile text updated!', 1500);
            });
            
            // FIX APPLIED HERE: Swap the arguments to make + increase and - decrease
            textModalSizeUp.addEventListener('click', () => changeTextModalFontSize(1)); // Send 1 (UP)
            textModalSizeDown.addEventListener('click', () => changeTextModalFontSize(-1)); // Send -1 (DOWN)

            // --- Event Listeners (Rest of App) ---
            startImageBtn.addEventListener('click', () => startGame('image'));
            startTextBtn.addEventListener('click', () => startGame('text'));
            startAiBtn.addEventListener('click', () => startGame('ai'));
            startUnboxBtn.addEventListener('click', () => startGame('unbox'));

            newGameBtn.addEventListener('click', () => window.location.reload());

            slideControls.prev.addEventListener('click', () => loadSlide(currentSlideIndex - 1));
            slideControls.next.addEventListener('click', () => loadSlide(currentSlideIndex + 1));

            slideControls.add.addEventListener('click', () => {
                const currentSlide = lessonData[currentSlideIndex];
                const newSlide = JSON.parse(JSON.stringify(currentSlide));
                newSlide.id = crypto.randomUUID();

                lessonData.splice(currentSlideIndex + 1, 0, newSlide);

                if (isStudentMode) {
                    studentWork.splice(currentSlideIndex + 1, 0, []);
                }

                loadSlide(currentSlideIndex + 1);
            });

            slideControls.delete.addEventListener('click', () => {
                if (lessonData.length > 1) {
                    lessonData.splice(currentSlideIndex, 1);
                    if (isStudentMode) {
                        studentWork.splice(currentSlideIndex, 1);
                    }
                    if (currentSlideIndex >= lessonData.length) {
                        currentSlideIndex = lessonData.length - 1;
                    }
                    loadSlide(currentSlideIndex);
                }
            });

            clearTileBtn.addEventListener('click', () => {
                if (selectedCell) {
                    const row = selectedCell.dataset.row;
                    const col = selectedCell.dataset.col;

                    const cellData = lessonData[currentSlideIndex].gridData[row][col];
                    cellData.type = 'empty';
                    cellData.value = '';
                    cellData.fontSize = DEFAULT_FONT_SIZE;

                    updateCellUI(selectedCell, cellData);

                    selectedCell.classList.remove('selected');
                    selectedCell = null;
                    textEditModal.classList.add('hidden');
                    tileEditControls.classList.add('hidden');

                    showToast('Tile cleared!', 1500);
                }
            });

            // --- UNBOX Modal Listeners ---
            choiceCancelBtn.addEventListener('click', () => {
                tileChoiceModal.classList.add('hidden');
                if (selectedCell) {
                    selectedCell.classList.remove('selected');
                    selectedCell = null;
                }
                tileEditControls.classList.add('hidden');
            });

            choiceImageBtn.addEventListener('click', () => {
                const { row, col } = tileChoiceModal.dataset;
                tileChoiceModal.classList.add('hidden');
                openImageUploader(row, col);
            });

            choiceTextBtn.addEventListener('click', () => {
                const { row, col } = tileChoiceModal.dataset;
                tileChoiceModal.classList.add('hidden');
                openTextEditor(row, col);
            });

            choiceAIBtn.addEventListener('click', () => {
                const { row, col } = tileChoiceModal.dataset;
                tileChoiceModal.classList.add('hidden');
                openAIModal(row, col);
            });
            // --- End of UNBOX Listeners ---

            instructionInput.addEventListener('change', () => {
                if (!isStudentMode) {
                    lessonData[currentSlideIndex].instruction = instructionInput.value;
                    showToast('Instruction updated!', 1500);
                }
            });

            // REMOVED: downloadOfflineBtn.addEventListener('click', saveLessonOffline);
            printPhysicalMatBtn.addEventListener('click', generatePhysicalMatPDF);

            aiModalCancel.addEventListener('click', () => aiModal.classList.add('hidden'));
            aiModalGenerate.addEventListener('click', generateAiImage);

            document.getElementById('forward-btn').addEventListener('click', () => addCommand('F'));
            document.getElementById('left-btn').addEventListener('click', () => addCommand('L'));
            document.getElementById('right-btn').addEventListener('click', () => addCommand('R'));
            document.getElementById('backward-btn').addEventListener('click', () => addCommand('B'));
            document.getElementById('go-btn').addEventListener('click', executeCommands);
            document.getElementById('clear-btn').addEventListener('click', () => {
                commands = [];
                updateCommandSequence();
            });
            document.getElementById('stop-btn').addEventListener('click', stopExecution);

            pathColorPicker.addEventListener('input', () => redrawFullPath());

            // --- NEW START POSITION MODAL LISTENERS ---
            setPosBtn.addEventListener('click', () => {
                if (isStudentMode) return;

                // Fill the modal inputs with current state
                posRowInput.value = gridRows - beebotState.row;
                posColInput.value = beebotState.col + 1;
                dirSelectInput.value = beebotState.dir;

                setPosModal.classList.remove('hidden');
                posRowInput.focus();
            });

            setPosModalCancel.addEventListener('click', () => {
                setPosModal.classList.add('hidden');
            });

            setPosModalSave.addEventListener('click', () => {
                if (isStudentMode) return; 

                let newUIRow = parseInt(posRowInput.value, 10);
                let newUICol = parseInt(posColInput.value, 10);
                let newDir = parseInt(dirSelectInput.value, 10);

                // Validation
                if (isNaN(newUIRow) || newUIRow < 1 || newUIRow > gridRows || isNaN(newUICol) || newUICol < 1 || newUICol > gridCols) {
                    showToast(`Invalid Position. Row must be 1-${gridRows}, Col must be 1-${gridCols}.`, 3000);
                    return; 
                }

                // Convert user-facing (1-indexed) values to internal (0-indexed) state
                const newInternalRow = gridRows - newUIRow;
                const newInternalCol = newUICol - 1;

                // Update the main beebot state
                beebotState = {
                    row: newInternalRow,
                    col: newInternalCol,
                    dir: newDir,
                };

                // CRITICAL: Update the slide's initial state so this change is saved
                lessonData[currentSlideIndex].initialBeebotState = { ...beebotState };

                // Apply the new new position
                stopExecution(); // This resets the path and applies the new start position
                
                setPosModal.classList.add('hidden');
                showToast('Bee-Bot start position updated for this slide!');
            });
            // --- END NEW START POSITION MODAL LISTENERS ---


            window.addEventListener('resize', resizeCanvasAndPath);

            // --- PUBLIC API for Firebase script ---
            return {
                showToast: showToast,
                loadSavedLesson: loadSavedLesson,
                getLessonData: () => lessonData,
                getGameMode: () => gameMode,
                getCustomBeeImage: () => customBeeImageUrl
            };

        })(); // End of beebotApp object

        document.addEventListener('DOMContentLoaded', () => {
            console.log("BeeBot App Initialized.");
            
            // The gallery prompt is now permanently in the HTML, hidden only on sm screens via CSS classes.
            // We ensure it is shown if the window size allows it.
            const galleryPromptVisual = document.getElementById('gallery-prompt-visual');
            if (galleryPromptVisual) {
                // Remove the 'hidden' class on DOM load for large screens, ensuring persistence
                 if (window.innerWidth >= 640) { // sm: breakpoint in Tailwind
                    galleryPromptVisual.classList.remove('hidden');
                }
            }
        });
    </script>
</body>
</html>
